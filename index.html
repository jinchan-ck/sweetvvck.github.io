<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT, sweetvvck, nodejs, java, golang, android" />





  <link rel="alternate" href="/atom.xml" title="Sweetvvck" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Sweetvvck">
<meta property="og:url" content="http://sweetvvck.github.io/index.html">
<meta property="og:site_name" content="Sweetvvck">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sweetvvck">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://sweetvvck.github.io/"/>





  <title> Sweetvvck </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sweetvvck</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://sweetvvck.github.io/2016/08/01/how-does-javascript-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sweetvvck">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sweetvvck">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/01/how-does-javascript-work/" itemprop="url">
                  Javascript 工作原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-01T11:30:11+08:00">
                2016-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/Javascript/" itemprop="url" rel="index">
                    <span itemprop="name">Javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/01/how-does-javascript-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/01/how-does-javascript-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/01/how-does-javascript-work/" class="leancloud_visitors" data-flag-title="Javascript 工作原理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Javascript-定义"><a href="#Javascript-定义" class="headerlink" title="Javascript 定义"></a>Javascript 定义</h2><ul>
<li>单线程</li>
<li>异步 IO</li>
<li>并发</li>
<li>基于原型的面线对象</li>
<li>脚本语言</li>
</ul>
<h2 id="Javascript-引擎与运行时环境"><a href="#Javascript-引擎与运行时环境" class="headerlink" title="Javascript 引擎与运行时环境"></a>Javascript 引擎与运行时环境</h2><p>Javascript 引擎和运行时环境这两个概念很容易被弄混，但它俩真不是一个东西。Javascript 引擎做的事情是实现 ECMAScript 标准，解释（或编译） Javascript 代码；而运行环境是包括引擎并提供一些类库让 Javascript 代码能够在其上运行，例如 Chrome, Node。</p>
<h2 id="为什么设计为单线程？"><a href="#为什么设计为单线程？" class="headerlink" title="为什么设计为单线程？"></a>为什么设计为单线程？</h2><blockquote>
<p>JavaScript语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。那么，为什么JavaScript不能有多个线程呢？这样能提高效率啊。<br>JavaScript的单线程，与它的用途有关。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？<br>所以，为了避免复杂性，从一诞生，JavaScript就是单线程，这已经成了这门语言的核心特征，将来也不会改变。<br>为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。<br>摘自 <a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2014/10/event-loop.html</a></p>
</blockquote>
<h2 id="单线程如何异步，如何并发？"><a href="#单线程如何异步，如何并发？" class="headerlink" title="单线程如何异步，如何并发？"></a>单线程如何异步，如何并发？</h2><p>我们知道，在一段程序代码中发起一个调用并等待直到调用返回结果再执行接下来的代码，这个调用对于这段程序来说是同步的；而发起一个调用后不用等待调用结果而直接执行后面的代码，这个调用对于这段程序来说就是异步的。</p>
<p>异步意味着在主逻辑中被异步调用的代码和主逻辑继续执行的代码会同时执行，这其实是实现了并发。回想一下我们在 Java 或者其它多线程语言中是如何实现异步的，一般来说，要创建一个异步任务，我们通常会创建一个线程然后在线程中执行该任务，这个任务和创建它的线程就可以并发执行了。但 Javascript 单线程的特性显然和这异步、并发是有冲突的，那么为什么说 Javascript 支持异步，支持并发呢？</p>
<p>其实理解起来也很简单，Javascript 本身并不是异步的，而 Javascript 程序是异步的。具体来说就是，Javascript 编写的代码自身运行于单线程中，当遇到 IO 调用，就把它丢给运行时环境处理，自身继续执行后面的代码，当 IO 调用有了结果，会将结果及回调放在一个队列里，Javascript 线程会在合适的时机将回调函数取出并执行。</p>
<p>Javascript 程序的异步由其运行时环境提供，通过<code>event loop</code>实现异步编程，并提供并发支持。</p>
<p>实现异步编程可以有很多种方式(<code>编程模型</code>)，想了解更多可以先看看<a href="http://www.jianshu.com/p/c4dc7866eb81" target="_blank" rel="external">这篇文章</a>。</p>
<h2 id="Javascript-具体是如何工作的"><a href="#Javascript-具体是如何工作的" class="headerlink" title="Javascript 具体是如何工作的"></a>Javascript 具体是如何工作的</h2><p>单说<code>Javascript 是如何工作的</code>其实不太准确，应该说<code>Javascript 在其运行时环境上是如何工作的</code>才对，Node 和 Chrome 都是 Javascript 的运行时环境，它们使用相同的  JavaScript 引擎(V8)，都应用基于 <code>event loop</code> 的并发模型( Chrome 内核使用了 libevent 而 Node 则基于 libuv )，那么 Javascript 在这样的运行时环境下是如何工作的呢？</p>
<p>是时候祭出这张图了<br><img src="https://pub.int64ago.org/5couq20oh7kfu8ebqpvi.png" alt=""></p>
<blockquote>
<p>此图来自Philip Roberts的演讲<a href="http://vimeo.com/96425312" target="_blank" rel="external">《Help, I’m stuck in an event-loop》</a></p>
</blockquote>
<p>这张图讲的是 Javascript 在浏览器中的工作原理，在 Node 中也差不多，很具有代表性。</p>
<p><strong>看图说话</strong></p>
<ol>
<li>V8 在编译执行 Javascript 代码过程中会生成堆( heap ) 和栈 ( stack )，heap 存放的程序运行过程中产生的一些对象，stack 是 Javascript 执行栈，程序代码会根据调用关系被压入栈中执行；</li>
<li>当遇到调用 WebAPIs（IO 或者 定时器）时，浏览器会响应调用并直接返回，stack 继续执行剩余 Javascript 代码；</li>
<li>当 WebAPIs 调用完成，会将相应的回调与结果依次放入 <code>callback queue</code> 中；</li>
<li>当执行栈中如果没有要执行的 Javascript 代码，则会通过 <code>event loop</code> 检查并取出 <code>callback queue</code> 中第一个回调函数，并执行它。</li>
</ol>
<p>这样，我们所编写的 Javascript 代码会在<code>执行引擎</code>的执行栈中以单线程的方式运行，而所有 IO 或定时任务会通过运行环境异步执行，并将执行结果放在 <code>callback queue</code> 中等待被调用，这就是所谓的单线程异步的工作原理，当然  Javascript 实际运行环境的实现会比这复杂一些，但基本原理就是这样；理解这个原理能够让我们更加清楚我们的每一段代码在运行环境中是如何执行的，有很多疑惑例如：程序代码中的多个回调会在什么时候被调用？为什么复杂的计算逻辑要使用 <code>setImmediate(function () { // 计算逻辑 }); 或 process.nextTick(function () { // 计算逻辑 });</code> 包起来？就容易理解了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文主要解释了 Javascript 作为单线程语言，其程序是如何实现异步的，同时也大概讲解了 Javascript 在其运行时环境中的工作原理；在解惑的同时也带来了一些疑惑：</p>
<ul>
<li><code>setImmediate 和 process.nextTick</code> 的区别是什么？</li>
<li>既然 Javascript 程序也是通过(运行时环境)底层的多线程实现异步，那跟多线程语言实现的异步有什么不同？</li>
<li>为什么说基于 <code>Event loop</code> 实现异步编程模型的 <code>Node</code> 更适合 IO 密集型的应用，底层不都是多线程吗？</li>
</ul>
<p>这些问题也是我在做 Javascript 开发不同阶段中真真实实遇到的疑惑，通过自己一步一步的探索得到了一些解释，希望也能帮到正遇到这些疑惑的朋友们，如有问题，请指出。</p>
<p>篇幅原因（才怪，因为懒）这些疑惑下一篇再来探讨。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://blog.csdn.net/lin_credible/article/details/40143961" target="_blank" rel="external">朴灵评注-JavaScript 运行机制详解：再谈Event Loop</a><br><a href="http://vimeo.com/96425312" target="_blank" rel="external">Help, I’m stuck in an event-loop</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop" target="_blank" rel="external">并发模型与Event Loop</a><br><a href="http://www.cnblogs.com/dolphinX/p/3475090.html" target="_blank" rel="external">关于node.js的误会</a><br><a href="https://github.com/goddyZhao/GPosts/blob/master/javascript/%E9%80%9A%E8%BF%87%E4%BB%80%E4%B9%88%E9%80%94%E5%BE%84%E8%83%BD%E5%A4%9F%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3JavaScript%E8%A7%A3%E6%9E%90%E5%BC%95%E6%93%8E%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F.md" target="_blank" rel="external">通过什么途径能够深入了解JavaScript解析引擎是如何工作的？</a><br><a href="https://cnodejs.org/topic/4f16442ccae1f4aa2700113b" target="_blank" rel="external">nodejs异步IO的实现</a></p>
<!--有没有真正的异步编程模型-->

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://sweetvvck.github.io/2015/12/29/译-打造atom成为golang开发神器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sweetvvck">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sweetvvck">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/29/译-打造atom成为golang开发神器/" itemprop="url">
                  [译]打造atom成为golang开发神器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-12-29T00:37:30+08:00">
                2015-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Editor/Language/" itemprop="url" rel="index">
                    <span itemprop="name">Language</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/29/译-打造atom成为golang开发神器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/29/译-打造atom成为golang开发神器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2015/12/29/译-打造atom成为golang开发神器/" class="leancloud_visitors" data-flag-title="[译]打造atom成为golang开发神器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在我在Windows系统上开发的日子里，我使用IDE开发数年之久，例如Visual Basic IDE, Borland Delphi IDE, Visual C&#43;&#43; 和最后的Visual Studio；但当我在大约10年前转到Mac OS X下开发后，我放弃了上述所有的IDE。</p>
<p>我刚进入Mac编程世界的时候使用的是当时表现极好的Textmate编辑器。它是一个开发代码飞快的编辑器，拥有很好的语法高亮，拓展模块以及代码片段(code snippets)，让我再次感觉非常高产。经过几年的衰退期，由于它没有继续更新了，很多人转向了Sublime Text和传统的VIM编辑器了。</p>
<p>Atom刚出来的时候我尝试使用了一下，但当时它并没有准备好。而最近几天它正式发布官方1.0版本后我决定再次试用一下，我很高兴我又试用了下atom。</p>
<p><a href="https://atom.io/" target="_blank" rel="external">https://atom.io/</a></p>
<h2 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h2><p>你一天将要花大部分时间看着代码，注视着你的编辑器，因此你总是必须要找到一个颜色搭配自然的主题，并且要能够让你的&#30524;睛觉得舒服。我认为这个因人而异，你需要找一个你最喜欢的。</p>
<p>我现在一直使用的主题是One Dark UI Theme和Monokai-Seti Syntax theme(译者注：atom的主题分为UI主题和语法主题)，我很享受使用这样的主题搭配。</p>
<p><img src="http://marcio.io/img/atom-theme.png" alt="atom-theme"></p>
<p>下图是这样的主题搭配在我的电脑上的效果:</p>
<p><img src="http://marcio.io/img/atom-editor.png" alt="atom-editor"></p>
<h4 id="monokai-seti"><a href="#monokai-seti" class="headerlink" title="monokai-seti"></a>monokai-seti</h4><ul>
<li><a href="https://atom.io/packages/monokai-seti" target="_blank" rel="external">https://atom.io/packages/monokai-seti</a></li>
</ul>
<h2 id="安装开发专用字体"><a href="#安装开发专用字体" class="headerlink" title="安装开发专用字体"></a>安装开发专用字体</h2><p>我第一次打开atom想做的第一件事情是：安装一个我更喜欢的开发专用字体，我使用免费字体“Inconsolata”有一阵子了。</p>
<p>你可以通过这个链接查看和下载这个字体：<a href="http://www.levien.com/type/myfonts/inconsolata.html" target="_blank" rel="external">http://www.levien.com/type/myfonts/inconsolata.html</a></p>
<p>你可以使用标准的编辑器设置很便捷的切换正在使用的字体。</p>
<h2 id="安装开发语言包"><a href="#安装开发语言包" class="headerlink" title="安装开发语言包"></a>安装开发语言包</h2><p>Atom自带的标准包里涵盖了大部分开发语言。我做Go开发还差两个语言包，分别是Dockerfile语法和Google Protobuf语法，这两个在我的项目中大量被使用到。</p>
<ul>
<li>language-docker:&nbsp;<a href="https://atom.io/packages/language-docker" target="_blank" rel="external">https://atom.io/packages/language-docker</a></li>
<li>language-protobuf:&nbsp;<a href="https://atom.io/packages/language-protobuf" target="_blank" rel="external">https://atom.io/packages/language-protobuf</a></li>
</ul>
<h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><h4 id="go-plus"><a href="#go-plus" class="headerlink" title="go-plus"></a>go-plus</h4><ul>
<li><a href="https://atom.io/packages/go-plus" target="_blank" rel="external">https://atom.io/packages/go-plus</a></li>
</ul>
<p>这个插件提供了Atom中几乎所有go语言开发的支持，包括&nbsp;tools, build flows, linters, vet 和 coverage tools。它还包含很多代码片段和一些其它特性。</p>
<p>在你的命令行中输入下面的命令来确保你安装了所有go tools：</p>
<p>go get -u golang.org/x/tools/cmd/…<br>go get -u github.com/golang/lint/golint</p>
<p>go-plus有非常多的特性，但我在开发时最喜欢的是它能够实时的给我反馈语法错误和编译错误。每当我保存一个文件，go-plus就会在后台运行你提前配置好的要执行的go tools，例如：go vet, go oracle, go build等等，然后将错误和警告在编辑器底部显示出来。这个功能非常赞，而且大大提升了开发速度。</p>
<p><img src="http://marcio.io/img/atom-go-plus-linter.png" alt="atom-go-plus-linter"></p>
<p>它同样能够在编辑器的对应行上显示该行的编译错误提示和错误信息，这样你就能很快的定位哪一行有错。错误和警告分别用红色和淡黄色做区分。</p>
<p><img src="http://marcio.io/img/atom-go-plus-gutter-errors.png" alt="atom-go-plus-gutter-errors"></p>
<h4 id="go-rename"><a href="#go-rename" class="headerlink" title="go-rename"></a>go-rename</h4><ul>
<li><a href="https://atom.io/packages/go-rename" target="_blank" rel="external">https://atom.io/packages/go-rename</a></li>
</ul>
<p>这个插件通过食用Go rename tool，提供非常智能和安全的 变量，方法和结构体重命名功能。当你选中一个目标时，你能够通过快捷键&nbsp;ALT-R&nbsp;很方便的初始化重命名对话框。</p>
<p>让Atom更像VIM</p>
<p>你可能想问我“那为什么不直接使用VIM呢？”情况是这样的，我确实有使用VIM一年多，但是我想尝试使用Atom，我很享受atom的体验，特别是我能够在atom上使用所有的VIM命令。</p>
<ul>
<li>vim-mode:&nbsp;<a href="https://atom.io/packages/vim-mode" target="_blank" rel="external">https://atom.io/packages/vim-mode</a></li>
<li>vim-surround:&nbsp;<a href="https://atom.io/packages/vim-surround" target="_blank" rel="external">https://atom.io/packages/vim-surround</a></li>
<li>last-cursor-position:&nbsp;<a href="https://atom.io/packages/last-cursor-position" target="_blank" rel="external">https://atom.io/packages/last-cursor-position</a></li>
</ul>
<h5 id="在-Keymap-文件中定义一些快捷键："><a href="#在-Keymap-文件中定义一些快捷键：" class="headerlink" title="在 Keymap 文件中定义一些快捷键："></a>在 Keymap 文件中定义一些快捷键：</h5><p>&#39;atom-text-editor:not(mini).autocomplete-active&#39;:<br>  &#39;ctrl-p&#39;: &#39;core:move-up&#39;<br>  &#39;ctrl-n&#39;: &#39;core:move-down&#39;</p>
<p>&#39;.vim-mode.command-mode:not(.mini)&#39;:<br>  &#39;ctrl-f&#39;: &#39;core:page-down&#39;<br>  &#39;/&#39;: &#39;find-and-replace:show&#39;</p>
<p>还有一个VIM模块Easy-Motion上面没有说到，这是因为它和Atom 1.0不兼容，但是我相信很快就会有人来更新它或者在创建一个新版本。</p>
<h2 id="自定义atom的TreeView"><a href="#自定义atom的TreeView" class="headerlink" title="自定义atom的TreeView"></a>自定义atom的TreeView</h2><h4 id="file-icons"><a href="#file-icons" class="headerlink" title="file-icons"></a>file-icons</h4><ul>
<li><a href="https://atom.io/packages/file-icons" target="_blank" rel="external">https://atom.io/packages/file-icons</a></li>
</ul>
<p>我刚开始想这个插件能够让我的tree view色彩丰富，它提针对不同后缀的文件，文件夹供了大量的icon显示。然后我使用了一下它，发现它确实很酷。并且它能够让我很快的一扫就能找到我要找的文件。它还有些配置，可以让你选择显示哪些文件的icon等。</p>
<p>下面你可以看到如果你安装了file-icons插件后你的tree view会变成什么样。试试吧，我确定你会喜欢它的。</p>
<p><img src="http://marcio.io/img/file-icons.png" alt="file-icons"></p>
<h4 id="应用一些自定义CSS"><a href="#应用一些自定义CSS" class="headerlink" title="应用一些自定义CSS"></a>应用一些自定义CSS</h4><p>默认的TreeView行距有些过高，所以我想要修改css减少行间的padding。还有一个要修改的地方是，treeview的字体也要修改成我在编辑框中使用的字体，来保持样式的一致性。我通常使用Inconsolata<br> 。</p>
<p>// style the background color of the tree view<br>.tree-view {<br>    font-family: &quot;Inconsolata&quot;;<br>    font-size: 12px;<br>}</p>
<p>.list-group li:not(.list-nested-item),<br>.list-tree li:not(.list-nested-item),<br>.list-group li.list-nested-item &gt; .list-item,<br>.list-tree li.list-nested-item &gt; .list-item {<br>    line-height:18px;<br>}</p>
<p>.list-group .selected:before,<br>.list-tree .selected:before {<br>    height:18px;<br>}</p>
<p>.list-tree.has-collapsable-children .list-nested-item &gt; .list-tree &gt; li,<br>.list-tree.has-collapsable-children .list-nested-item &gt; .list-group &gt; li {<br>    padding-left:12px;<br>}</p>
<h3 id="代码片段-Code-Snippets"><a href="#代码片段-Code-Snippets" class="headerlink" title="代码片段(Code Snippets)"></a>代码片段(Code Snippets)</h3><p>大部分流行的编辑器和IDE都会使用code-completion针对不同语言的特定关键字自动补全代码。这样通常能够包含最常用的代码，但是离真正的补全还差一截。</p>
<p>但是Atom允许你在snippets.cson文件中创建自己的代码片段仓库。在Atom的菜单栏可以打开这个文件，然后你就可以创建自己的代码片段库了。</p>
<p>你需要使用.source.go&nbsp;作为scope，这样这个片段就只会在你编辑go文件时提示你了。</p>
<p>下面是我最近添加的一些代码片段：</p>
<p>&#39;.source.go&#39;:<br>    &#39;return nil and error&#39;:<br>      &#39;prefix&#39;: &#39;rne&#39;<br>      &#39;body&#39;: &#39;return nil, err&#39;</p>
<pre><code>&amp;#39;return false and error&amp;#39;:
  &amp;#39;prefix&amp;#39;: &amp;#39;rfe&amp;#39;
  &amp;#39;body&amp;#39;: &amp;#39;return false, err&amp;#39;

&amp;#39;Return True and Nil&amp;#39;:
  &amp;#39;prefix&amp;#39;: &amp;#39;rte&amp;#39;
  &amp;#39;body&amp;#39;: &amp;#39;return true, nil&amp;#39;

&amp;#39;Import logrus&amp;#39;:
  &amp;#39;prefix&amp;#39;: &amp;#39;logrus&amp;#39;
  &amp;#39;body&amp;#39;: &amp;#39;log &amp;quot;github.com/Sirupsen/logrus&amp;quot;&amp;#39;
</code></pre><p>一旦你创建好代码片段，你立马就能在编辑器中使用。我非常喜欢这个功能，他能让我编码速度飞快。</p>
<p><img src="http://marcio.io/img/atom-complete-snippets.png" alt="atom-complete-snippets"></p>
<h3 id="Dash"><a href="#Dash" class="headerlink" title="Dash"></a>Dash</h3><p>Dash是一个Mac OS X下的非常棒的商业软件，它能够让你在离线模式下实时访问150&#43;的API 文档。我在做Ruby开发时使用了几年时间，现在做go开发同样适用它。</p>
<p>了解Dash：&nbsp;<a href="https://kapeli.com/dash" target="_blank" rel="external">https://kapeli.com/dash</a></p>
<p><img src="http://marcio.io/img/atom-dash.png" alt="atom-dash"></p>
<p>有一个Atom插件能够让你通过快捷键<code>CTRL-H</code>&nbsp;直接跳转动dash，这样查询选中方法的方法定义文档就非常方便了。</p>
<h4 id="dash"><a href="#dash" class="headerlink" title="dash"></a>dash</h4><p><a href="https://atom.io/packages/dash" target="_blank" rel="external">https://atom.io/packages/dash</a></p>
<h2 id="自定义编辑器样式"><a href="#自定义编辑器样式" class="headerlink" title="自定义编辑器样式"></a>自定义编辑器样式</h2><p>Atom有一个相比其它编辑器非常大的优点是，它能够通过食用css完全的自定义编辑器UI。如果你对atom不满意，几乎atom所有方面都能够被你自己修改和提高。</p>
<p>改变 Symbol View 的样式</p>
<p>atom有一个让我很困扰的区域是原声的Symbols-View对话框，它的行太高了，并且不能很好的在查看窗口适应很多行显示。我更喜欢Sublime的显示方式，所以我把atom的symbol view的样式改成和sublime一样。</p>
<p>.symbols-view {<br>  &amp;.select-list ol.list-group li .primary-line,<br>  &amp;.select-list ol.list-group li .secondary-line {</p>
<pre><code>font-family: Inconsolata;
font-size: 14px;

// let lines wrap
text-overflow: initial;
white-space: initial;
overflow: initial;

// reduce line-height
line-height: 1.0em;
padding-top: .1em;
padding-bottom: .0em;

// make sure wrapped lines get padding
// padding-left: 21px;
&amp;amp;.icon:before {
  margin-left: -21px;
}

.character-match {
    color: rgb(200, 200, 10) !important;
}
</code></pre><p>  }<br>}</p>
<p>.symbols-view {<br>  &amp;.select-list ol.list-group li .secondary-line {<br>      float: right;<br>      margin-top: -12px;<br>      padding-top: 0em;<br>      padding-bottom: 0em;<br>      font-size: 12px;<br>      color: rgba(200, 200, 10, 0.8) !important;<br>  }<br>}</p>
<p>这是一个更精简的Symbol View，可以看到行高减少了，行数提示放在了右侧：</p>
<p><img src="http://marcio.io/img/atom-symbol-view-styles.png" alt="atom-symbol-view-styles"></p>
<h3 id="自定义行选中效果"><a href="#自定义行选中效果" class="headerlink" title="自定义行选中效果"></a>自定义行选中效果</h3><p>有个很有趣的插件叫 Hightlight-Line:</p>
<p><a href="https://atom.io/packages/highlight-line" target="_blank" rel="external">https://atom.io/packages/highlight-line</a></p>
<p>这个插件允许你修改选中行的样式。在我的例子中，我在选中行上下侧加上了黄色的虚线。我喜欢这样的样式，它能够让我很好的识别我所选中的区域。</p>
<p><img src="http://marcio.io/img/atom-highlight-selected.png" alt="atom-highlight-selected"></p>
<p>你可以将‘solid’替换为 ‘dashed’ 或者 ‘dotted’。</p>
<p>atom-text-editor::shadow {</p>
<pre><code>.line.highlight-line {
    background: rgba(255, 255, 255, 0.05) !important;
}

.line.highlight-line-multi-line-dashed-bottom {
    border-bottom-color: yellow !important;
}

.line.highlight-line-multi-line-dashed-top {
    border-top-color: yellow !important;
}
</code></pre><p>}</p>
<h2 id="为Go代码生成-Ctags"><a href="#为Go代码生成-Ctags" class="headerlink" title="为Go代码生成 Ctags"></a>为Go代码生成 Ctags</h2><p>自动补全在开发中是一个非常重要的功能，同时也让开发这非常困扰。它的提示必须非常好不然的话经常出现的不对的提示信息会非常的讨厌。当需要提示的时候却没有提示时更是烦上加烦。</p>
<p>有一个非常棒的插件叫&nbsp;<code>gotags</code>&nbsp;，它能够兼容ctags并且专为go设计。它将AST工具化，并且会解析Go的标准库，非常的智能。它比标准的ctags工具生成的ctags好太多。</p>
<ul>
<li>gotags:&nbsp;<a href="https://github.com/jstemmer/gotags" target="_blank" rel="external">https://github.com/jstemmer/gotags</a></li>
</ul>
<p>通过下面命令安装gotags</p>
<p>go get -u github.com/jstemmer/gotags</p>
<p>在你的源码目录下执行下面命令声称ctags：</p>
<p>gotags -tag-relative=true -R=true -sort=true -f=&quot;tags&quot; -fields=+l .</p>
<p>这将会在你的项目根目录下生成新的tags文件，让你的代码提示更加智能。</p>
<p><img src="http://marcio.io/img/atom-go-tags.png" alt="atom-go-tags"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>无论你是Sublime Text爱好者还是VIM粉丝，你都应该尝试使用一下1.0版本的atom。</p>
<p>特别是它还是一个在Github.com上的开源项目，项目非常活跃，并且社区增长的也非常快。</p>
<p>快试试吧！！</p>
<pre><code>    作者：sweetvvck 发表于2015/12/29 0:37:30 [原文链接](http://blog.csdn.net/sweetvvck/article/details/50333327)


阅读：237 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/50333327#comments)
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://sweetvvck.github.io/2015/12/16/原-Gitflow实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sweetvvck">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sweetvvck">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/16/原-Gitflow实践/" itemprop="url">
                  [原]Gitflow实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-12-16T01:14:03+08:00">
                2015-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/项目管理/" itemprop="url" rel="index">
                    <span itemprop="name">项目管理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/16/原-Gitflow实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/16/原-Gitflow实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2015/12/16/原-Gitflow实践/" class="leancloud_visitors" data-flag-title="[原]Gitflow实践">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载请注明出处：<a href="http://blog.csdn.net/sweetvvck/article/details/50245147" target="_blank" rel="external">Gitflow实践</a></p>
<h1 id="Gitflow实践"><a href="#Gitflow实践" class="headerlink" title="Gitflow实践"></a>Gitflow实践</h1><p>这两周在和别的团队的两个小伙伴开发新项目，他们团队刚刚成立不久，各种规范还没跟上，于是我便各种安利我们团队的工作流，其中代码管理方面我就推荐他们使用gitflow。在给他们讲gitflow的过程中我发现他们不是很理解这种工作方式，或者说不太明白为什么要这样做，为了加深自己对gitflow的理解我觉得有必要记录一下，也让正在学习使用gitflow的同学们有个初步的了解。</p>
<hr>
<h2 id="Git工作流"><a href="#Git工作流" class="headerlink" title="Git工作流"></a>Git工作流</h2><p>现在越来越多的项目开始使用git做为版本控制工具，我对版本控制工具的最初印象是：能把代码提交到远端让大家一起协作，能开分支，能回滚代码，能看到每次提交的修改等。不过git命令具体如何使用不是本文的重点(熟悉git可以参考<a href="http://blog.csdn.net/sweetvvck/article/details/38414713" target="_blank" rel="external"> GIT基本概念和用法总结</a> 和<a href="http://blog.csdn.net/sweetvvck/article/details/38548985" target="_blank" rel="external"> git - 简易指南</a>)，本文的重点是在项目中如何使用git来高效清晰的处理开发协作，版本控制。Git的工作流其实就是对git在项目上的一个完整的使用方式归纳总结，比较流行的git工作流有：Gitflow Workflow, Centralized Workflow, Feature Branch Workflow, Forking Workflow。</p>
<p>值得注意的是，这些workflow只是作为如何更好的使用git的指导方针，而非<code>&quot;铁律&quot;</code>，我们也可以根据具体项目来组合使用不同的workflow。本文重点讲解Gitflow Workflow，有想了解其他git工作流的可以参考这篇文章：<a href="https://www.atlassian.com/git/tutorials/comparing-workflows" target="_blank" rel="external">Comparing Workflows</a>。</p>
<h2 id="Gitflow-workflow"><a href="#Gitflow-workflow" class="headerlink" title="Gitflow workflow"></a>Gitflow workflow</h2><p>Gitflow从功能开发到正式发布再到热修复等都有相应的策略管理，可以说是非常的完善，对于大型的项目也能够很好的管理。</p>
<h3 id="Gitflow-分支"><a href="#Gitflow-分支" class="headerlink" title="Gitflow 分支"></a>Gitflow 分支</h3><p>Gitflow使用不同的分支表达了它在工作流中的不同概念：</p>
<ul>
<li><strong>Master分支存放所有正式发布的版本，可以作为项目历史版本记录分支</strong></li>
<li><strong>Develop分支为主开发分支</strong></li>
<li><strong>Feature/xx分支为新功能分支，feature分支都是基于develop创建的，开发完成后会合并到develop分支上</strong></li>
<li><strong>Release分支基于最新develop分支创建，当新功能足够发布一个新版本(或者接近新版本发布的截止日期)，从develop分支创建一个release分支作为新版本的起点，开发完成后合并到master并打上版本号，同时也合并到develop，更新最新开发分支</strong></li>
<li><strong>Hotfix分支基于Master分支创建，对线上版本的bug进行修复，完成后直接合并到master分支和develop分支</strong></li>
</ul>
<p><img src="https://www.atlassian.com/git/images/tutorials/collaborating/comparing-workflows/gitflow-workflow/05.svg" alt="Gitflow分支"></p>
<h3 id="Gitflow具体流程"><a href="#Gitflow具体流程" class="headerlink" title="Gitflow具体流程"></a>Gitflow具体流程</h3><p>上文提到，从项目启动到发布版本都能够使用gitflow管理，具体如何管理，下 main这张图表达的很清楚：</p>
<p><img src="http://nvie.com/img/git-model@2x.png" alt="这里写图片描述"></p>
<p>从上图可以看到，随着时间的推移：</p>
<ol>
<li>项目启动时只有master分支(图最右侧，蓝色)，开发到0.1版本时给它打上tag:0.1；</li>
<li>接着创建了develop分支(黄色)开始接下来的开发；</li>
<li>在开发的过程中发现0.1版本有bug，基于master分支0.1版本创建hotfix分支修复bug，修复完成后同时合并到develop分支和master分支，并在master分支上打上版本号；</li>
<li>团队成员创建不同的feature分支(红色)开发下个版本的新功能，完成后合并到develop分支上；</li>
<li>当feature完成情况按照项目计划能够发布新版本1.0时，创建release分支，对该分支进行测试修复，通过测试后release分支将被同时合并到develop分支和master分支，同时master分支打上相应版本号；</li>
<li>继续上面的流程</li>
</ol>
<p>⚠️注意：feature与其它分支互不影响，不必要在发布新版本前完成所有feature，发布版本时也可以有feature开发同时进行。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>Gitflow workflow是由<a href="http://nvie.com/" target="_blank" rel="external">Vincent Driessen</a> 提出来的，要实现上述的工作流程需要使用到他创建的命令行工具<a href="https://github.com/nvie/gitflow" target="_blank" rel="external">git-flow</a> 具体如何使用请参考<a href="http://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html" target="_blank" rel="external">git-flow 备忘清单</a>。</p>
<p>另外，有一款git客户端软件<a href="https://www.sourcetreeapp.com/" target="_blank" rel="external">sourcetree</a> 集成了gitflow命令，提供了非常便捷的方式使用gitflow流程。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>熟练掌握和Gitflow workflow能够团队内项目协作开发流程更加规范化，更加清晰化，但是不必过于拘泥于其定义的流程，这类workflow只是使用git的指导方针，目的都是高效的使用git协作。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="external">A successful Git branching model</a></li>
<li><a href="https://www.atlassian.com/git/tutorials/comparing-workflows" target="_blank" rel="external">Comparing Workflows</a></li>
<li><p><a href="http://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html" target="_blank" rel="external">git-flow 备忘清单</a></p>
<pre><code>作者：sweetvvck 发表于2015/12/16 1:14:03 [原文链接](http://blog.csdn.net/sweetvvck/article/details/50245147)
</code></pre></li>
</ol>
<pre><code>阅读：508 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/50245147#comments)
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://sweetvvck.github.io/2015/05/08/原-Koa中间件方式实现API的Undo功能/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sweetvvck">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sweetvvck">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/08/原-Koa中间件方式实现API的Undo功能/" itemprop="url">
                  [原]Koa中间件方式实现API的Undo功能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-05-08T23:12:05+08:00">
                2015-05-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/05/08/原-Koa中间件方式实现API的Undo功能/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/08/原-Koa中间件方式实现API的Undo功能/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2015/05/08/原-Koa中间件方式实现API的Undo功能/" class="leancloud_visitors" data-flag-title="[原]Koa中间件方式实现API的Undo功能">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Koa中间件方式实现API的Undo功能"><a href="#Koa中间件方式实现API的Undo功能" class="headerlink" title="Koa中间件方式实现API的Undo功能"></a>Koa中间件方式实现API的Undo功能</h1><h2 id="API的Undo功能"><a href="#API的Undo功能" class="headerlink" title="API的Undo功能"></a>API的Undo功能</h2><p>使用过Gmail或者163邮箱的同学会经常看到，当对邮件进行一些操作时会出现一个类似Toast的提示（大致意思是：操作已经完成，是否撤销）如下图所示：</p>
<p><img src="http://img.blog.csdn.net/20150508220504487" alt=""></p>
<p><img src="http://img.blog.csdn.net/20150508220843186" alt=""></p>
<p>当点击撤销时，之前执行的操作能够被还原，这种设计对于用户的误操作是一个非常棒的补救方案。</p>
<p>之前听过一句有关交互设计的话说的非常好，不要在用户每做一步操作时弹出Alert让用户选择”确定”或者”取消”，更好的做法是执行操作，然后让用户能够Undo。</p>
<h2 id="实现API-Undo的方案"><a href="#实现API-Undo的方案" class="headerlink" title="实现API Undo的方案"></a>实现API Undo的方案</h2><p>其实Undo是很老的技术，在编辑器中无处不在，只是在API设计中使用的还比较少。最近一直在使用Node开发，因此想使用Node实现一下API的Undo。</p>
<p>首先要明确几点：</p>
<ul>
<li>并不是所有的API都需要Undo，比如获取数据的接口就完全没有Undo的必要（而且逻辑上也没办法做）</li>
<li>只能针对用户最后一次操作进行Undo</li>
<li>Undo是在用户维度的，用户不能Undo其他用户的操作</li>
</ul>
<h3 id="传统方案-Plan-A-："><a href="#传统方案-Plan-A-：" class="headerlink" title="传统方案(Plan A)："></a>传统方案(Plan A)：</h3><ul>
<li>需要对所有需要Undo的接口提供Undo逻辑;</li>
<li>当用户要Undo最近一次操作时需要调用这个方法（常常会涉及数据库操作）。</li>
</ul>
<h3 id="新方案-Plan-B-："><a href="#新方案-Plan-B-：" class="headerlink" title="新方案(Plan B)："></a>新方案(Plan B)：</h3><ul>
<li>以中间件(类似Java中的拦截器)方式提供Undo服务</li>
<li>对需要Undo的API逻辑放入指定队列延迟执行</li>
<li>调用Undo接口时将最近一次操作从延迟执行的队列中移除</li>
<li>调用其他接口是立即执行延迟队列中的逻辑</li>
</ul>
<h2 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h2><h3 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h3><h4 id="方案A"><a href="#方案A" class="headerlink" title="方案A:"></a>方案A:</h4><ul>
<li>可以对任意接口进行undo操作；</li>
<li>逻辑简单，undo时无需操作数据库；</li>
</ul>
<h4 id="方案B"><a href="#方案B" class="headerlink" title="方案B:"></a>方案B:</h4><ul>
<li>操作真实反映到了数据库；</li>
<li>无需限制undo过期时间；</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><h4 id="方案A-1"><a href="#方案A-1" class="headerlink" title="方案A:"></a>方案A:</h4><ul>
<li>访问可undo接口后，再访问非undo接口，之前逻辑不能undo；</li>
</ul>
<h4 id="方案B-1"><a href="#方案B-1" class="headerlink" title="方案B:"></a>方案B:</h4><ul>
<li>逻辑较为复杂，undo需要做数据库操作；</li>
<li>并非所有操作都能够undo；</li>
</ul>
<h2 id="方案实现"><a href="#方案实现" class="headerlink" title="方案实现"></a>方案实现</h2><p>通过上边的方案对比，我发现Plan A更简单、灵活，因此决定实现Plan A。</p>
<p>使用过Koa的通许都知道，koa的中间件非常强大（类似Java web开发中的拦截器），它能够拦截所有请求并执行一些逻辑，例如计算API请求到响应时长等，这里我们就可以使用这个特性将需要Undo的API延迟执行。</p>
<p>首先我们要设置Undo的超时时间，以及那些API需要Undo：</p>
<pre><code>var apis = (options || {}).apis;
var expired = (options || {}).expired || 3000;`

还要明确当前访问API的用户：

`/**
 * `x-identify-key` is used to identify the user of this request,
 * one user can not undo another`s request.
 */

var user = context.header[&apos;x-identify-key&apos;];`

然后延迟执行API逻辑：

`var undo = yield delayNext(user, expired, context);`

如果用户没有调用Undo接口，则执行逻辑，否则返回’undo’:

`if (!undo) { return yield next; }
this.body = &apos;undo&apos;;`

如果用户调用Undo接口，移除延迟执行的逻辑；调用其他接口则立即执行延迟的逻辑：

`clearTimeout(undoObj.timeoutId);
if (path === &apos;/undo&apos; &amp;amp;&amp;amp; method === &apos;POST&apos;) {
  undoObj.delayFn.call(undoObj.context, true);
  context.body = &apos;done&apos;;
  return;
} else if (undoObj.delayFn) {
  undoObj.delayFn.call(undoObj.context, false);
}`

具体实现逻辑大概就这些，完整代码如下：

`
/**
 * Store users&apos; undo context
 *
 * @type {Object}
 */
var undos = {};

/**
 * Expose `undo`
 *
 * @param {Object} options Config object for undo
 * @example
 * {
 *   expired: 3000
 * }
 */
module.exports = function (options) {
  var apis = (options || {}).apis;
  var expired = (options || {}).expired || 3000;

  return function* (next) {
    var context = this;
    var path = context.path;
    var needUndo = false;

    if (apis &amp;amp;&amp;amp; Array.isArray(apis) &amp;amp;&amp;amp; apis.length) {
      needUndo = apis.filter(function (api) {
        return path === api;
      }).length;
    }

    if (!needUndo &amp;amp;&amp;amp; path !== &apos;/undo&apos;) { return yield next; }

    var method = context.method;
    /**
     * Can not undo get request.
     */
    if (method === &apos;GET&apos;) { return yield next; }
    /**
     * &apos;x-identify-key&apos; is used to identify the user of this request,
     * one user can not undo another&apos;s request.
     */
    var user = context.header[&apos;x-identify-key&apos;];
    if (!user) { return yield next; }

    var undoObj = undos[user];
    if (undoObj) {
      clearTimeout(undoObj.timeoutId);
      if (path === &apos;/undo&apos; &amp;amp;&amp;amp; method === &apos;POST&apos;) {
        undoObj.delayFn.call(undoObj.context, true);
        context.body = &apos;done&apos;;
        return;
      } else if (undoObj.delayFn) {
        undoObj.delayFn.call(undoObj.context, false);
      }
    }
    var undo = yield delayNext(user, expired, context);
    if (!undo) { return yield next; }
    this.body = &apos;undo&apos;;
  };
};

/**
 * Block the logic for specified ms.
 *
 * @param {String} user The user&apos;s identity
 * @param {String} expired The expired ms
 * @param {Object} context The koa context object
 * @api private
 */
function delayNext(user, expired, context) {
  return function (callback) {
    var delayFn = function (undo) {
      delete undos[user];
      callback(null, undo);
    };
    var timeoutId = setTimeout(delayFn, expired);
    undos[user] = {
      timeoutId: timeoutId,
      delayFn: delayFn,
      context: context
    };
  };
}
</code></pre><h2 id="项目相关"><a href="#项目相关" class="headerlink" title="项目相关"></a>项目相关</h2><p>目前此项目托管在Github上，<a href="https://github.com/sweetvvck/koa-undo" target="_blank" rel="external">https://github.com/sweetvvck/koa-undo</a>，koa-undo具体使用方法项目主页有详细介绍，感兴趣的同学欢迎提Issue、PR；同时koa-undo也发布到了Npm上，<a href="https://www.npmjs.com/package/koa-undo" target="_blank" rel="external">https://www.npmjs.com/package/koa-undo</a> ，欢迎大家使用。</p>
<pre><code>    作者：sweetvvck 发表于2015/5/8 23:12:05 [原文链接](http://blog.csdn.net/sweetvvck/article/details/45585997)


阅读：730 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/45585997#comments)
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://sweetvvck.github.io/2014/12/31/译-Twemproxy来自Twitter的Redis代理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sweetvvck">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sweetvvck">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/12/31/译-Twemproxy来自Twitter的Redis代理/" itemprop="url">
                  [译]Twemproxy来自Twitter的Redis代理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-31T22:35:41+08:00">
                2014-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/12/31/译-Twemproxy来自Twitter的Redis代理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/31/译-Twemproxy来自Twitter的Redis代理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2014/12/31/译-Twemproxy来自Twitter的Redis代理/" class="leancloud_visitors" data-flag-title="[译]Twemproxy来自Twitter的Redis代理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在大量用户大规模使用大型Redis节点的时候，目前从项目本身来看Redis基本上可以说是一个单例的业务。</p>
<p>关于这个项目的分布式我有一个很大的想法，在这个想法下，我不需要去对多线程版本的Redis做任何评估：在这个角度上对我来说，一个核就像是一台计算机，所以在多核上扩展就相当于分布在计算机之间的集群。多实例是一个无共享的架构。如果我们找到一个可用的方式来分片，那么所有事情就合理了。 :-)</p>
<p>这也是为什么集群会成为Redis在2013年的焦点，并且，最终Redis 2.6的发布表现出了很好的稳定性和成熟度，现在正是时候来关注Redis Cluster, Redis Sentinel, 以及一些其它期待已久的改进。</p>
<p>然而现实状况是，Redis Cluster目前仍然没有发布，正式版还需要几个月的工作。但是我们的用户已经需要将数据分片到不同的实例上来做负载均衡，更重要的是为数据获得更大的内存存储。</p>
<p>目前保底的结局方案是客户端分片。客户端分片有很多好处，例如：在客户端和节点之间没有中间层，这就意味着它是一个扩展性很好的设置（主要是线性扩展）。然而要稳定的实现（客户端分片）需要进行一些优化，需要一个同步客户端配置的方式，也需要客户端支持一致性哈希或其它分区算法。</p>
<p>有一个重大消息来自Twitter，世界最大的Redis集群之一部署在Twitter用于为用户提供时间轴数据。所以毫不奇怪这篇文章讨论的项目来自Twitter Open Source部门。</p>
<h2 id="Twemproxy"><a href="#Twemproxy" class="headerlink" title="Twemproxy"></a>Twemproxy</h2><p>Twemproxy是一个快速的单线程代理程序，支持Memcached ASCII协议和更新的Redis协议：&nbsp;</p>
<p>它全部用C写成，使用Apache 2.0 License授权。&nbsp;<br>项目在Linux上可以工作，而在OSX上无法编译，因为它依赖了epoll API.<br>我的测试环境为Ubuntu 12.04桌面版。&nbsp;</p>
<p>好吧，闲话少叙。twemproxy到底做了什么？（注：我将关注Redis到部分，但是该项目也可以对memcached做相同到事情）&nbsp;</p>
<p>1) 在客户端和众多Redis实例间作为代理。&nbsp;<br>2) 在配置的Redis实例之间进行自动到数据分片。&nbsp;<br>3) 支持一致性哈希，支持不同到策略和哈希方法。&nbsp;</p>
<p>Twemproxy最了不起的地方就在于它能在节点失败的时候卸载它，然后可以在一段时间以后重新尝试（随即）连接，又或者可以严&#26684;按照配置文件中写的键与服务器之间对应关系进行连接。这意味着Twemproxy能胜任把Redis当做数据存储（不能容忍节点未命中）的场景，也能够胜任当做缓存来使用，那些允许（它意味着少量，不是说低质量）未命中且高可用的场景。<br>总结来说就是：如果你能容忍未命中，那么当有节点失败你的数据也许会存储到其他节点，所以它会是弱一致性的。另一方面，如果你不能容忍未命中，那么你需要一个拥有高可用的实例的方案，例如使用Redis监控的失败自动切换功能。</p>
<p>安装 &nbsp;<br>—&nbsp;</p>
<p>在深入项目的更多特性之前，有一个好消息，它在Linux上非常容易构建。好吧，没有Redis那么简单，但是……你仅仅需要简单按照下面的几步操作：<br>apt-get install automake&nbsp;<br>apt-get install libtool&nbsp;<br>git clone git://github.com/twitter/twemproxy.git&nbsp;<br>cd twemproxy&nbsp;<br>autoreconf -fvi&nbsp;<br>./configure –enable-debug=log&nbsp;<br>make&nbsp;<br>src/nutcracker -h&nbsp;</p>
<p>它的配置也非常简单，在项目的github页面上有足够的文档可以让你有一个平滑的初体验。我使用了如下的配置：<br>redis1:&nbsp;<br>&nbsp; listen: 0.0.0.0:9999&nbsp;<br>&nbsp; redis: true&nbsp;<br>&nbsp; hash: fnv1a_64&nbsp;<br>&nbsp; distribution: ketama&nbsp;<br>&nbsp; auto_eject_hosts: true&nbsp;<br>&nbsp; timeout: 400&nbsp;<br>&nbsp; server_retry_timeout: 2000&nbsp;<br>&nbsp; server_failure_limit: 1&nbsp;<br>&nbsp; servers:&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6379:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6380:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6381:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6382:1&nbsp;</p>
<p>redis2:&nbsp;<br>&nbsp; listen: 0.0.0.0:10000&nbsp;<br>&nbsp; redis: true&nbsp;<br>&nbsp; hash: fnv1a_64&nbsp;<br>&nbsp; distribution: ketama&nbsp;<br>&nbsp; auto_eject_hosts: false&nbsp;<br>&nbsp; timeout: 400&nbsp;<br>&nbsp; servers:&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6379:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6380:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6381:1&nbsp;<br>&nbsp; &nbsp;- 127.0.0.1:6382:1&nbsp;</p>
<p>第一个集群配置为（故障时）节点自动排除，第二个集群则在所有实例上配置了静态映射。&nbsp;</p>
<p>有趣的是，针对同一组服务器你能同时有多个部署。然而在生产环境更适合使用多个示例以利用多核的能力。</p>
<p>单点失效？&nbsp;<br>—&nbsp;</p>
<p>还有另一件有趣的事情，使用这个部署并不意味着有单点失效问题，你可以通过运行多套twemproxy，让你的客户端连接到第一个可用的实例。&nbsp;</p>
<p>通过使用twemproxy你基本上把分片逻辑和客户端进行了分离。在这种情况下，一个基本的客户端就可以实现目的，分片将完全由代理来处理。<br>这是一个直接而安全的方法，个人观点。<br>现在Redis Cluster还不成熟，twemproxy是大多数希望利用Redis集群的用户的好方法。也不要太激动，先看看这种方法的限制 ;)</p>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>我认为Twemproxy没有支持批量操作的命令和事物是对的。当然，AFAIK甚至比Redis cluster更严&#26684;，反而它对于相同的键允许批量操作。<br>但是恕我直言按照这种方式，分散的集群带来分散的效率，并且将这个挑战带给了早期的用户，而且花费了大量的资源，从大量的实例中汇总数据，得到仅仅是“能用”的结果，而且你将很快开始有严重的负载问题，因为你有太多的时间花费在数据的传输上。</p>
<p>可是有一些批量操作命令还是支持了的。MGET和DEL是处理的非常好的。有趣的是MGET命令在不同的服务器之间切分请求并且返回一个结果。这一点相当酷，也许我以后不能有更好的性能（看以后的吧）。<br>无论如何，批量操作和事物的不支持的现状意味着Twemproxy不适用于每个人，特别像Redis cluster本身。特别是它显然不支持EVAL（我认为他们应该支持它！它是多通用的，EVAL被设计可以在代理中工作，是因为键的名字已经明确了）。</p>
<h2 id="有待改进的地方"><a href="#有待改进的地方" class="headerlink" title="有待改进的地方"></a>有待改进的地方</h2><p>错误报告机制并不稳定，发送一个Redis不支持的命令会导致连接被关闭。比如从redis-cli只发送一个‘GET‘并不会报&quot;参数个数不正确”的错误，只会导致连接被挂起。<br>总体看来，服务器返回的其它错误都可以准确的传给客户端：<br>redis metal: 10000 &gt; get list<br>(错误)类型操作错误，键匹配了错误的&#20540;类型<br>另外一个我想要看到的特性是对自动故障恢复的支持。有很多种替代方案：<br>1) twemproxy已经能够监控实例错误信息、错误的数量、在检测出足够多的错误的情况下断开节点。但是很遗憾twemproxy不能够拿从节点作为替代方案，这样就可以发送一个SLAVE OFNOONE命令来弃用备用节点，而不用只是断开错误节点。这种情况下twemproxy才是一个具有高可用性的解决方案。<br>2) 或者，我希望twemproxy能够与Redis Sentinel一起协同工作，定期检查Sentinel配置，如果出现故障则更新服务端配置<br>3) 另外一种替代方案是提供一种热配置twemproxy的方式，一旦节点出故障，Redis Sentinel就能够切换ASAP代理配置<br>有很多种替代方案，总体来说，如果能够提供对HA(高可用性)的底层支持就非常棒了。</p>
<h2 id="性能-nbsp"><a href="#性能-nbsp" class="headerlink" title="性能&nbsp;"></a>性能&nbsp;</h2><p>Twemproxy很快，真的很快，接近直接与Redis通讯的速度。我敢说你用的话最多损失20%的性能。<br>我对性能唯一的意见是可以有更高效的方法把IMHO MGET命令分发到实例之间<br>如果twemproxy与所有Redis实例的延迟很相&#20284;的话(很有可能)，在MGETs命令在同一时间发出的情况下，twemproxy很有可能会在同一时间接收到所有节点的命令，所以我希望看到的是当我在所有实例上运行MGET命令的时候，发送的数量和twemproxy接收到的数量是一致的，但是实际上twemproxy在一秒内只接收到了50%的MGET命令。也许是时候重构twemproxy的应答模块了。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>这是个伟大的项目，鉴于Redis Cluster还未发布，我强烈建议有需求的Redis用户试一下Twemproxy<br>我正打算将它链接到Redis项目网站上，因为我认为Twitter的伙计已经用他们的项目为Redis做了不小的贡献，所以…<br>这是Twitter赢得荣誉！</p>
<pre><code>    作者：sweetvvck 发表于2014/12/31 22:35:41 [原文链接](http://blog.csdn.net/sweetvvck/article/details/42302675)


阅读：1373 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/42302675#comments)
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460"
               alt="Sweetvvck" />
          <p class="site-author-name" itemprop="name">Sweetvvck</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/sweetvvck" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/sweetvvck" target="_blank" title="Twitter">
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/sweetvvck" target="_blank" title="Weibo">
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.v2ex.com/member/sweetvvck" target="_blank" title="V2ex">
                  
                  V2ex
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sweetvvck</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"sweetvvck"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("lT3lO1Nw0l5r35n1QRjSpWlr-gzGzoHsz", "A0ADM3Flk4OnaWKxIHsUMKL7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


  

</body>
</html>
