<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Sweetvvck" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Sweetvvck">
<meta property="og:url" content="http://sweetvvck.com/page/2/index.html">
<meta property="og:site_name" content="Sweetvvck">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sweetvvck">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Sweetvvck </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sweetvvck</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/31/译-Android学习路线（三十二）在非UI线程中处理Bitmap/" itemprop="url">
                  [译]Android学习路线（三十二）在非UI线程中处理Bitmap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-10-31T23:41:35+08:00" content="2014-10-31">
              2014-10-31
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)">如果图片源数据是从硬盘，网络或是其他非内存中读取的话，</span>在<a href="http://developer.android.com/training/displaying-bitmaps/load-bitmap.html" target="_blank" rel="external">高效地夹在大Bitmaps</a>中讨论的<code>[BitmapFactory.decode*](http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeByteArray(byte[], int, int, android.graphics.BitmapFactory.Options))</code>方法就不能在主线程（UI线程）中执行。这种数据加载进内存的时间是不可预测的，并且还要依赖各种其他因素（磁盘读取速度，网络速度，图片大小，CPU性能等等）。如果这些任务的其中之一阻塞了UI线程，那么系统就认为你的app处于无响应状态并且弹出对话框提示用户关闭app。</p>
<p>本课介绍如何使用&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;在后台线程中处理bitmaps，同时粗略讲解如何处理并发事件。</p>
<p>##<br>使用AsyncTask</p>
<hr>
<p><code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;类提供了一个简单的方法来在后台线程处理任务，并且能够将处理结果在UI线程中返回。要使用它，需创建一个它的子类，然后覆盖几个必要的方法。下面这个例子向你展示如何使用&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;和<a href="http://developer.android.com/training/displaying-bitmaps/load-bitmap.html#decodeSampledBitmapFromResource" target="_blank" rel="external"><code>decodeSampledBitmapFromResource()</code></a>将大bitmap加载到ImageView中：</p>
<p><a target="_blank" name="BitmapWorkerTask" style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></a><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></span></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">class</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">extends</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncTask</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">Integer</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Void</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">private</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">WeakReference</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> imageViewReference</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">private</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> data </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">0</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Use a WeakReference to ensure the ImageView can be garbage collected</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; imageViewReference </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">WeakReference</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pun" style="color:rgb(102,102,0)">&gt;(</span><span class="pln" style="color:rgb(0,0,0)">imageView</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="com">// Decode image in background.</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="lit" style="color:rgb(0,102,102)">@Override</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">protected</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pln" style="color:rgb(0,0,0)"> doInBackground</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Integer</span><span class="pun" style="color:rgb(102,102,0)">...</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">params</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; data </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">params</span><span class="pun" style="color:rgb(102,102,0)">[</span><span class="lit" style="color:rgb(0,102,102)">0</span><span class="pun" style="color:rgb(102,102,0)">];</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> decodeSampledBitmapFromResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getResources</span><span class="pun" style="color:rgb(102,102,0)">(),</span><span class="pln" style="color:rgb(0,0,0)"> data</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">100</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">100</span><span class="pun" style="color:rgb(102,102,0)">));</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="com">// Once complete, see if ImageView is still around and set bitmap.</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="lit" style="color:rgb(0,102,102)">@Override</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">protected</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">void</span><span class="pln" style="color:rgb(0,0,0)"> onPostExecute</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pln" style="color:rgb(0,0,0)"> bitmap</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageViewReference </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">&amp;&amp;</span><span class="pln" style="color:rgb(0,0,0)"> bitmap </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> imageViewReference</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">get</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imageView</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">setImageBitmap</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">bitmap</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>&nbsp;到<a href="http://developer.android.com/reference/java/lang/ref/WeakReference.html" target="_blank" rel="external">WeakReference</a>&nbsp;确保了<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;不会阻止<code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>&nbsp;以及它引用的对象不会被垃圾回收。由于并不能确保&nbsp;<code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>&nbsp;在任务执行结束后仍然存在，我们在使用它之前需要对它进行检查。<code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>&nbsp;有可能已经不存在了，例如，用户切换到其他的activity中又或者在任务结束前发生了配置改变（横竖屏切换）都可能导致上述情况。</p>
<p>要异步地加载这个bitmap，只需要简单地执行下面的代码：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">void</span><span class="pln" style="color:rgb(0,0,0)"> loadBitmap</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> task </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; task</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">execute</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">resId</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>##<br>处理并发</p>
<hr>
<p>通常的视图组件像<code>[ListView](http://developer.android.com/reference/android/widget/ListView.html)</code>&nbsp;和&nbsp;<code>[GridView](http://developer.android.com/reference/android/widget/GridView.html)</code>，如果像上一节中示范的那样与&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;一起使用会引出其他的问题。为了提高内存使用效率，这些组件在滚动过程中会重用它们的子View。如果每个子View都触发了一个&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>，那么这些AsyncTask结束后没有任何确保，它们之前关联的View可能已经被重用了。并且，AsyncTask开始的顺序并不意味着它们的结束顺训。</p>
<p><a href="http://android-developers.blogspot.com/2010/07/multithreading-for-performance.html" target="_blank" rel="external">Multithreading for Performance</a>&nbsp;这片文章讨论了如何处理并发，并且提供了提供了一个解决方法：将ImageView的引用存储起来，然后等到&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;结束后查找对应的引用。使用一个类&#20284;的方法，上一节使用的&nbsp;<code>[AsyncTask](http://developer.android.com/reference/android/os/AsyncTask.html)</code>&nbsp;将会使用类&#20284;的模式进行简单的扩展。</p>
<p>创建一个专用的<code>[Drawable](http://developer.android.com/reference/android/graphics/drawable/Drawable.html)</code>&nbsp;子类来存储任务的引用。在这种情况下，这个<code>[BitmapDrawable](http://developer.android.com/reference/android/graphics/drawable/BitmapDrawable.html)</code>&nbsp;的作用是让一个占位的图片在task结束后能够被显示在这个ImageView上：</p>
<p><a target="_blank" name="AsyncDrawable" style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></a><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></span></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">static</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">class</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">extends</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapDrawable</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">private</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">WeakReference</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTaskReference</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Resources</span><span class="pln" style="color:rgb(0,0,0)"> res</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pln" style="color:rgb(0,0,0)"> bitmap</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">super</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">res</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> bitmap</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; bitmapWorkerTaskReference </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">WeakReference</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">&gt;(</span><span class="pln" style="color:rgb(0,0,0)">bitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> getBitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">()</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTaskReference</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">get</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><code>&lt;span style=&quot;font-family:Roboto,sans-serif&quot;&gt;&lt;span style=&quot;font-size:14px; line-height:19px&quot;&gt;在执行&lt;/span&gt;&lt;/span&gt;[BitmapWorkerTask](http://developer.android.com/training/displaying-bitmaps/process-bitmap.html#BitmapWorkerTask)</code><span style="font-family:Roboto,sans-serif"><span style="font-size:14px; line-height:19px">之前，你需要先创建一个</span></span><a href="http://developer.android.com/training/displaying-bitmaps/process-bitmap.html#AsyncDrawable" target="_blank" rel="external"><code>AsyncDrawable</code></a><span style="font-family:Roboto,sans-serif"><span style="font-size:14px; line-height:19px">&nbsp;同时将它绑定到目标</span></span><code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code><span style="font-family:Roboto,sans-serif"><span style="font-size:14px; line-height:19px">：</span></span></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">void</span><span class="pln" style="color:rgb(0,0,0)"> loadBitmap</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">cancelPotentialWork</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">))</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> task </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pln" style="color:rgb(0,0,0)"> asyncDrawable </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getResources</span><span class="pun" style="color:rgb(102,102,0)">(),</span><span class="pln" style="color:rgb(0,0,0)"> mPlaceHolderBitmap</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> task</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; imageView</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">setImageDrawable</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">asyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; task</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">execute</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">resId</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><code>cancelPotentialWork</code>&nbsp;和上面的代码示例对应，检查是否已经有一个运行中的task与此ImageView相关联。如果是，此方法尝试通过调用<code>[cancel()](http://developer.android.com/reference/android/os/AsyncTask.html#cancel(boolean))</code>方法取消此任务。在少数情况下，新的task数据和已经存在的task匹配，即可直接返回。下面是<code>cancelPotentialWork</code>的示例代码：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">static</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">boolean</span><span class="pln" style="color:rgb(0,0,0)"> cancelPotentialWork</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> data</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTask </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getBitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">bitmapWorkerTask </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> bitmapData </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">data</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// If bitmapData is not yet set or it differs from the new data</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">bitmapData </span><span class="pun" style="color:rgb(102,102,0)">==</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">0</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">||</span><span class="pln" style="color:rgb(0,0,0)"> bitmapData </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> data</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Cancel previous task</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">cancel</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">else</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// The same work is already in progress</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">false</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="com">// No task associated with the ImageView, or an existing task was cancelled</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><code>getBitmapWorkerTask()</code>, 用于获取与指定<code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>关联的任务：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">private</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">static</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> getBitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp;</span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Drawable</span><span class="pln" style="color:rgb(0,0,0)"> drawable </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> imageView</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getDrawable</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">drawable </span><span class="kwd" style="color:rgb(0,0,136)">instanceof</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pln" style="color:rgb(0,0,0)"> asyncDrawable </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">AsyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> drawable</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> asyncDrawable</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getBitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>最后一步是在<code>[BitmapWorkerTask](http://developer.android.com/training/displaying-bitmaps/process-bitmap.html#BitmapWorkerTask)&amp;nbsp;中</code>更新&nbsp;<code>onPostExecute()</code>&nbsp;方法，&nbsp;检查task是否被取消以及当前的task是否与跟ImageView关联的那个匹配：</p>
<p><a target="_blank" name="BitmapWorkerTaskUpdated" style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></a><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></span></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">class</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">extends</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">AsyncTask</span><span class="pun" style="color:rgb(102,102,0)">&lt;</span><span class="typ" style="color:rgb(102,0,102)">Integer</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Void</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">...</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="lit" style="color:rgb(0,102,102)">@Override</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">protected</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">void</span><span class="pln" style="color:rgb(0,0,0)"> onPostExecute</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pln" style="color:rgb(0,0,0)"> bitmap</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color:inherit"><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">isCancelled</span><span class="pun" style="color:rgb(102,102,0)">())</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bitmap </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span></span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageViewReference </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">&amp;&amp;</span><span class="pln" style="color:rgb(0,0,0)"> bitmap </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">ImageView</span><span class="pln" style="color:rgb(0,0,0)"> imageView </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> imageViewReference</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">get</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color:inherit"><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapWorkerTask</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTask </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getBitmapWorkerTask</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">imageView</span><span class="pun" style="color:rgb(102,102,0)">);</span></span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span style="color:inherit"><span class="kwd" style="color:rgb(0,0,136)">this</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">==</span><span class="pln" style="color:rgb(0,0,0)"> bitmapWorkerTask </span><span class="pun" style="color:rgb(102,102,0)">&amp;&amp;</span></span><span class="pln" style="color:rgb(0,0,0)"> imageView </span><span class="pun" style="color:rgb(102,102,0)">!=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imageView</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">setImageBitmap</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">bitmap</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><span style="font-family:Roboto,sans-serif; font-size:14px; line-height:19px">这样的实现就也适用于&nbsp;<code>[ListView](http://developer.android.com/reference/android/widget/ListView.html)</code>&nbsp;和&nbsp;<code>[GridView](http://developer.android.com/reference/android/widget/GridView.html)</code>&nbsp;</span><span style="font-family:monospace"><span style="font-size:13px; line-height:14px">了，即使它们重用子View。</span></span><span style="font-family:Roboto,sans-serif"><span style="font-size:14px; line-height:19px">&nbsp;只需要简单的在你为ImageView设置图片的地方调用一下&nbsp;</span></span><code>loadBitmap</code><span style="font-family:Roboto,sans-serif"><span style="font-size:14px; line-height:19px">&nbsp;方法。例如在ListView对应的Adapter的getView方法中调用。</span></span></p>
<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/10/31 23:41:35 [原文链接](http://blog.csdn.net/sweetvvck/article/details/40663987)
&lt;/div&gt;
&lt;div&gt;
阅读：363 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/40663987#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/31/译-Android学习路线（三十一）高效地加载大的Bitmap/" itemprop="url">
                  [译]Android学习路线（三十一）高效地加载大的Bitmap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-10-31T23:40:38+08:00" content="2014-10-31">
              2014-10-31
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>图片的大小形状千变万化。在很多情况下图片都比一个app的UI所需要展示的大小大很多。例如，系统的相册应用所展示的用系统相机拍摄的相片，这些相片比手机屏幕的分辨率大得多。</p>
<p>假设你的app所使用的内存有限制，理想情况下你只想要在内存中加载一个较低分辨率的图片。同事这个低分辨率的图片要匹配用来显示它的UI组件的大小。高分辨率的图片并不能带来任何可见的好处，但是仍然会消耗珍贵的内存同时还会导致额外的性能开销。</p>
<p>本课将会讲解如何在不溢出app内存限制的情况下通过在内存中加载小版本图片来解码大bitmaps。</p>
<p>##<br>读取Bitmap的尺寸和类型</p>
<hr>
<p><code>[BitmapFactory](http://developer.android.com/reference/android/graphics/BitmapFactory.html)</code>&nbsp;类提供几种解码方法(<code>[decodeByteArray()](http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeByteArray(byte[], int, int, android.graphics.BitmapFactory.Options))</code>,&nbsp;<code>[decodeFile()](http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeFile(java.lang.String, android.graphics.BitmapFactory.Options))</code>,<code>[decodeResource()](http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeResource(android.content.res.Resources, int, android.graphics.BitmapFactory.Options))</code>,<br> 等等.)来通过多种多样的资源文件创建&nbsp;<code>[Bitmap](http://developer.android.com/reference/android/graphics/Bitmap.html)</code>&nbsp;。根据你的图片数据源选择一个最合适的解码方法。这些方法为bitmap分配内存，这样就很容易导致<code>OutOfMemory</code>&nbsp;异常。每种类型的解码方法都有额外的参数以让你通过<code>[BitmapFactory.Options](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html)</code>&nbsp;类指定解码的选项。在解码时设置<code>[inJustDecodeBounds](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds)</code>&nbsp;属性为&nbsp;<code>true</code>&nbsp;能够避免内存分配，同时还能够获取到<code>[outWidth](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#outWidth)</code>,&nbsp;<code>[outHeight](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#outHeight)</code>&nbsp;和&nbsp;<code>[outMimeType](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#outMimeType)</code>&nbsp;的&#20540;，此时解码方法返回的bitmap对象为null。这种发式允许你在构建这个bitmap<span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)">（和内存分配）</span>之前读取它的大小和类型。</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Options</span><span class="pln" style="color:rgb(0,0,0)"> options </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Options</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">inJustDecodeBounds </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">decodeResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getResources</span><span class="pun" style="color:rgb(102,102,0)">(),</span><span class="pln" style="color:rgb(0,0,0)"> R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">id</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">myimage</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> imageHeight </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">outHeight</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> imageWidth </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">outWidth</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> imageType </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">outMimeType</span><span class="pun" style="color:rgb(102,102,0)">;</span></pre>

<p><code>&lt;span style=&quot;color:#222222&quot;&gt;为了避免&lt;/span&gt;``java.lang.OutOfMemory</code><span style="font-family:Roboto,sans-serif; color:#222222"><span style="font-size:14px; line-height:19px">&nbsp;异常，可以在每次解码它之前取得它的尺寸，除非你完全肯定这个图片源的大小的消耗能够在可用内存之内。</span></span></p>
<p>##<br>在内存中加载图片的压缩版本</p>
<hr>
<p>现在图片的尺寸已经知道了，我们就能够决定是否加载原图还是图片的缩小版本。下面有几点需要考虑:</p>
<ul>
<li>预估加载完整图片所需的内存使用量。</li>
<li>你想要为加载此图片分配的内存的总量。</li>
<li>要载入的目标<code>[ImageView](http://developer.android.com/reference/android/widget/ImageView.html)</code>&nbsp;或者UI组件的尺寸。</li>
<li>当前设备的屏幕大小和密度。</li>
</ul>
<p>例如，如果一张图片要在一个ImageView中被展示成一个<span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)">128x96像素的缩略图，那么加载一个</span>1024x768 像素的图片进内存是完全不&#20540;得的。</p>
<p>告诉解码者压缩图片，加载一个压缩版图片进入内存，需要在<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html" target="_blank" rel="external">BitmapFactory.Options</a>对象中设置&nbsp;<code>[inSampleSize](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code>&nbsp;为&nbsp;<code>true</code>。例如，一个图片，分辨率为&nbsp;2048x1536以&nbsp;<code>[inSampleSize](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code>&nbsp;＝<br> 4为参数被解码，将会产生一个分辨率大概为512x384的bitmap。加载它进内存只需要使用0.75MB 内存，而非加载完整图片所需的12MB (假定bitmap的配置为<code>[ARGB_8888](http://developer.android.com/reference/android/graphics/Bitmap.Config.html)</code>)。下面是一个基于目标长度和宽度计算压缩图片尺寸&#20540;的方法：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">static</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> calculateInSampleSize</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Options</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> reqWidth</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> reqHeight</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="com">// Raw height and width of image</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> height </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">outHeight</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> width </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">outWidth</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> inSampleSize </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">1</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">height </span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> reqHeight </span><span class="pun" style="color:rgb(102,102,0)">||</span><span class="pln" style="color:rgb(0,0,0)"> width </span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> reqWidth</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> halfHeight </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> height </span><span class="pun" style="color:rgb(102,102,0)">/</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">2</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> halfWidth </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> width </span><span class="pun" style="color:rgb(102,102,0)">/</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">2</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// height and width larger than the requested height and width.</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">while</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">((</span><span class="pln" style="color:rgb(0,0,0)">halfHeight </span><span class="pun" style="color:rgb(102,102,0)">/</span><span class="pln" style="color:rgb(0,0,0)"> inSampleSize</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> reqHeight
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">&amp;&amp;</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">halfWidth </span><span class="pun" style="color:rgb(102,102,0)">/</span><span class="pln" style="color:rgb(0,0,0)"> inSampleSize</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">&gt;</span><span class="pln" style="color:rgb(0,0,0)"> reqWidth</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inSampleSize </span><span class="pun" style="color:rgb(102,102,0)">*=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">2</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> inSampleSize</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><strong>Note:</strong>&nbsp;A power of two value is calculated because the decoder uses a final value by rounding down to the nearest power of two, as per the&nbsp;<code>[inSampleSize](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code>&nbsp;documentation.</p>
<p>要使用这个方法，首先需要按照之前的方式获取图片的尺寸和类型，然后在通过计算出的&nbsp;<code>[inSampleSize](http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code>&nbsp;&#20540;来生成bitmap：</p>
<p><a target="_blank" name="decodeSampledBitmapFromResource" style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></a><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"></span></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">static</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Bitmap</span><span class="pln" style="color:rgb(0,0,0)"> decodeSampledBitmapFromResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Resources</span><span class="pln" style="color:rgb(0,0,0)"> res</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> reqWidth</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> reqHeight</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="com">// First decode with inJustDecodeBounds=true to check dimensions</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">final</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Options</span><span class="pln" style="color:rgb(0,0,0)"> options </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Options</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">inJustDecodeBounds </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">decodeResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">res</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="com">// Calculate inSampleSize</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">inSampleSize </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> calculateInSampleSize</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">options</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> reqWidth</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> reqHeight</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">

&nbsp; &nbsp; </span><span class="com">// Decode bitmap with inSampleSize set</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; options</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">inJustDecodeBounds </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">false</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">BitmapFactory</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">decodeResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">res</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> resId</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> options</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>下面这种方式很简单的实现了加载一个很大的图片到一个100x100像素缩略图的ImageView中：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="pln" style="color:rgb(0,0,0)">mImageView</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">setImageBitmap</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; decodeSampledBitmapFromResource</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getResources</span><span class="pun" style="color:rgb(102,102,0)">(),</span><span class="pln" style="color:rgb(0,0,0)"> R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">id</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">myimage</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">100</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="lit" style="color:rgb(0,102,102)">100</span><span class="pun" style="color:rgb(102,102,0)">));</span></pre>

<p>你也可以使用类&#20284;的流程从其他图片源中解码bitmap，根据需要使用适当的解码方法<code>[BitmapFactory.decode*](http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeByteArray(byte[], int, int, android.graphics.BitmapFactory.Options))</code>&nbsp;。</p>
<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/10/31 23:40:38 [原文链接](http://blog.csdn.net/sweetvvck/article/details/40663965)
&lt;/div&gt;
&lt;div&gt;
阅读：398 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/40663965#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/31/译-Android学习路线（三十）高效地显示Bitmaps/" itemprop="url">
                  [译]Android学习路线（三十）高效地显示Bitmaps
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-10-31T23:39:24+08:00" content="2014-10-31">
              2014-10-31
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="jd-descr" style="height:972px; color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><br>学习如何使用常规的技术来加载<code>[Bitmap](http://developer.android.com/reference/android/graphics/Bitmap.html)</code>&nbsp;对象，保持你的UI灵敏，同时避免溢出应用内存限制。如果你不注意，bitmaps能够很快地消费你的可用内存预算，让你的app<br> crash掉，并且跑出下面这个可怕的异常：<br><br><code>java.lang.OutofMemoryError: bitmap size exceeds VM budget</code>.<br><br>下面有几个原因来说明在Android应用中加载bitmaps是很棘手的：<br><br><em>   移动设备的典型特征是系统资源有限。有些Android设备每个App可以小到仅有16M的可用内存。应用应该在这种内存限制下做优化。然而，很多设备已经可以配置到更高的限制。
</em>   Bitmaps占用了很多内存，特别是色彩丰富的图片，像照片。例如，&nbsp;<a href="http://www.android.com/devices/detail/galaxy-nexus" target="_blank" rel="external">Galaxy Nexus</a>&nbsp;中的相机照出的相片有2592x1936 像素 (5 百万像素)。如果这个bitmap使用的配置是&nbsp;<code>[ARGB_8888](http://developer.android.com/reference/android/graphics/Bitmap.Config.html)</code>&nbsp;(从Android2.3开始的默认配置)，那么加载这个图片到内存中需要占用19MB，这样马上就用光了某些设备的每个app的内存限制。<br><em>   Android app UI会频繁的需要多个bitmaps的一次载入。像&nbsp;<code>[ListView](http://developer.android.com/reference/android/widget/ListView.html)</code>,<code>[GridView](http://developer.android.com/reference/android/widget/GridView.html)</code>&nbsp;以及&nbsp;<code>[ViewPager](http://developer.android.com/reference/android/support/v4/view/ViewPager.html)</code>&nbsp;这些组件通常都会一次在屏幕上显示多个bitmaps同时还会有更多的bitmaps在后台等待被显示。<br><br>##<br>课程

</em> <em> </em><br><br><dl><dt><strong>高效地加载大Bitmaps</strong></dt><dd style="margin:0px 0px 10px 30px">此课程带你学习如何解码大bitmaps而不溢出app的内存限制。</dd><dt><strong>在非UI线程处理Bitmaps</strong></dt><dd style="margin:0px 0px 10px 30px">Bitmap处理(重置大小，从远端下载等等)都不应该在主UI线程中出现。此课程带你学习如何使用AsyncTask在后台线程中处理bitmaps，同时也会扩展一些处理并发的知识。</dd><dt><strong>缓存Bitmaps</strong></dt><dd style="margin:0px 0px 10px 30px">此课程教你使用内存和磁盘来缓存bitmap来提高你的UI加载大量图片时的响应速度和流畅性。</dd><dt><strong>管理Bitmap内存</strong></dt><dd style="margin:0px 0px 10px 30px">此课程想你解释如何管理bitmap内存来最优化你的app的表现。</dd><dt><strong>在你的UI中展示Bitmaps</strong></dt><dd style="margin:0px 0px 10px 30px">此课程将想你展示如何加载多个bitmaps到类&#20284;<code>[ViewPager](http://developer.android.com/reference/android/support/v4/view/ViewPager.html)</code>&nbsp;和&nbsp;<code>[GridView](http://developer.android.com/reference/android/widget/GridView.html)</code>&nbsp;的组件中，同时使用了后台线程和缓存。</dd></dl><br></div><br><div class="content-footer layout-content-row" style="display:inline-block; margin-bottom:10px; border-top-width:1px; border-top-style:solid; border-top-color:rgb(204,204,204); margin-top:10px; padding-top:10px; width:700px; color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><div class="paging-links layout-content-col col-10" style="float:left; margin-left:0px; position:relative; height:30px; display:inline; margin-right:10px; width:580px"><br></div><br></div>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/10/31 23:39:24 [原文链接](http://blog.csdn.net/sweetvvck/article/details/40663905)
&lt;/div&gt;
&lt;div&gt;
阅读：351 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/40663905#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/30/译-Android学习路线（二十八）保存文件/" itemprop="url">
                  [译]Android学习路线（二十八）保存文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-09-30T23:57:47+08:00" content="2014-09-30">
              2014-09-30
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载请注明出处：<a href="http://blog.csdn.net/sweetvvck/article/details/38645095" target="_blank" rel="external">Android学习路线（二十八）保存文件</a></p>
<p>Android使用了一个类&#20284;其他平台的基于磁盘的文件系统。本课将介绍如何使用android的文件APIS来在这样的文件系统中读写文件。</p>
<p><code>&lt;span style=&quot;color:#222222&quot;&gt;&lt;span style=&quot;font-size:14px; line-height:19px&quot;&gt;一个&lt;/span&gt;&lt;/span&gt;[File](http://developer.android.com/reference/java/io/File.html)</code><span style="font-family:Roboto,sans-serif; color:#222222"><span style="font-size:14px; line-height:19px">&nbsp;对象适用于顺序读写大块数据，而不适用于随机存取。例如它适用于文件或者其他通过网络交换的数据。</span></span></p>
<p>本课将想您介绍如何在app中处理基本的文件操作。在此之前，你需要对Linux文件系统以及标准的java文件apis有所了解。</p>
<p>##<br>选择内部或外部存储</p>
<hr>
<p>所有的Android设备都由两个存储区域：“内部”和“外部”存储。这两个名字来源于早期的android版本，当时大多数设备提供“内部构建”（built-in）不可拆卸的内部存储，以及可拆卸的存储媒介，例如微型SD卡。一些设备也将持久化存储设备分为“内部”和“外部”两个部分，因此即使是没有可拆卸媒介的设备也会有两个存储区域，而API的行为与设备是否有可拆卸存储介质无关，下面总结了每个存储区域的相关要点。</p>
<div class="col-5" style="display:inline; float:left; margin-left:0px; margin-right:10px; width:280px; color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><br><strong>内部存储：</strong><br><br><em>   任何时候都可用。
</em>   默认情况下只有在你的app中才能访问。<br><em>   当用户卸载你的app，系统将移除该应用在内部存储中的所有文件。<br><br>当你确定用户和其他app都不能访问到的情况下，内部存储是最佳选择。<br><br></em></div><br><div class="col-7" style="display:inline; float:left; margin-left:10px; margin-right:0px; width:400px; color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><br><strong>外部存储：</strong>

   它并不是任何时候都可用，因为用户能够像U盘一样使用它，同时它也可能随时被从设备上移除。<br><em>   它能被任何人访问，因此存储在这里的文件能够被其他app读取。
</em>   当用户卸载你的app，系统只会在你将文件保存在<a href="http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String" target="_blank" rel="external">getExternalFilesDir()</a>)&nbsp;中时才会在这里移除你app中的文件。<br><br>当你不需要控制文件的访问权限，同时你希望将文件和其他应用共享或者能够在电脑中访问到，那么外部存储是最好的选择。<br><br></div>

<p><strong>提示:</strong>&nbsp;即使是apps默认会被安装在内部存储中，你也可以在你的app中的manifest文件中指定<a href="http://developer.android.com/guide/topics/manifest/manifest-element.html#install" target="_blank" rel="external"><code>android:installLocation</code></a>&nbsp;属性，让你的app被安装在外部存储中。当apk的大小很大时，用户会非常希望这么做，他们会有一个远大于内部存储的外部存储空间。更多信息，请参阅<a href="http://developer.android.com/guide/topics/data/install-location.html" target="_blank" rel="external">App<br> Install Location</a>。</p>
<p>##<br>获取外部存储权限</p>
<hr>
<p>要能够在外部存储中写文件，你必须在manifest文件中申请&nbsp;<code>[WRITE_EXTERNAL_STORAGE](http://developer.android.com/reference/android/Manifest.permission.html#WRITE_EXTERNAL_STORAGE)</code>&nbsp;权限：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="tag" style="color:rgb(0,0,136)">&lt;manifest</span><span class="pln" style="color:rgb(0,0,0)"> ...</span><span class="tag" style="color:rgb(0,0,136)">&gt;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="tag" style="color:rgb(0,0,136)">&lt;uses-permission</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="atn" style="color:rgb(136,34,136)">android:name</span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="atv" style="color:rgb(136,0,0)">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="tag" style="color:rgb(0,0,136)">/&gt;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; ...
</span><span class="tag" style="color:rgb(0,0,136)">&lt;/manifest&gt;</span></pre>
<div class="caution" style="margin:0px 0px 15px; padding:0px 0px 0px 10px; border-left-width:4px; border-left-style:solid; border-color:rgb(255,136,0); color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)">

**注意:**&nbsp;目前，所有的应用都有权限读取外部存储中的文件。然而，在之后的版本中将会改变。如果你的app需要读取外部存储中的文件（但是不需要写入），你需要声明`[READ_EXTERNAL_STORAGE](http://developer.android.com/reference/android/Manifest.permission.html#READ_EXTERNAL_STORAGE)`&nbsp;权限。这样来保证你的app能够像预期那样工作。

<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="tag" style="color:rgb(0,0,136)">&lt;manifest</span><span class="pln" style="color:rgb(0,0,0)"> ...</span><span class="tag" style="color:rgb(0,0,136)">&gt;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="tag" style="color:rgb(0,0,136)">&lt;uses-permission</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="atn" style="color:rgb(136,34,136)">android:name</span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="atv" style="color:rgb(136,0,0)">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="tag" style="color:rgb(0,0,136)">/&gt;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; ...
</span><span class="tag" style="color:rgb(0,0,136)">&lt;/manifest&gt;</span></pre>

<p>然而，如果你的app使用了<code>[WRITE_EXTERNAL_STORAGE](http://developer.android.com/reference/android/Manifest.permission.html#WRITE_EXTERNAL_STORAGE)</code>&nbsp;权限，那么它就同时拥有了读写权限。</p>
<p></p></div><p></p>
<p>保存文件到内部存储中并不需要权限。你的app一直拥有在内部存储目录下的读写权限。</p>
<p>##<br>保存一个文件到内部存储中</p>
<hr>
<p>当保存文件到内部存储中时，你可以通过下面这两种方式获取一个合适的File对象：</p>
<dl style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><dt><code>[getFilesDir()](http://developer.android.com/reference/android/content/Context.html#getFilesDir())</code></dt><dd style="margin:0px 0px 10px 30px">返回一个表示你的app在内部存储中的目录的<code>[File](http://developer.android.com/reference/java/io/File.html)</code>&nbsp;对象。</dd><dt><code>[getCacheDir()](http://developer.android.com/reference/android/content/Context.html#getCacheDir())</code></dt><dd style="margin:0px 0px 10px 30px">返回一个表示你的app在内部存储中的临时目录的<code>[File](http://developer.android.com/reference/java/io/File.html)</code>&nbsp;对象。确保在你不需要该缓存文件时将其删掉，同时要指定一个合理的缓存文件大小限制，因为当系统缺少运行空间时会在不发出警告的情况下将该目录的文件删除。</dd></dl>

<p>要在上面两个目录之一中创建一个文件，你可以使用&nbsp;<code>[File()](http://developer.android.com/reference/java/io/File.html#File(java.io.File, java.lang.String))</code>&nbsp;构造方法，传入前面获取到的File对象作为内部存储的目录。例如：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> file </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getFilesDir</span><span class="pun" style="color:rgb(102,102,0)">(),</span><span class="pln" style="color:rgb(0,0,0)"> filename</span><span class="pun" style="color:rgb(102,102,0)">);</span></pre>

<p>同样的，你还可以调用&nbsp;<code>[openFileOutput()](http://developer.android.com/reference/android/content/Context.html#openFileOutput(java.lang.String, int))</code>&nbsp;方法来获取一个&nbsp;<code>[FileOutputStream](http://developer.android.com/reference/java/io/FileOutputStream.html)</code>&nbsp;，用于在你的内部存储中写入一个文件。例如，下面是如果像文件中写入一些文本：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> filename </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="str" style="color:rgb(136,0,0)">&quot;myfile&quot;</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="str" style="color:rgb(136,0,0)">&quot;Hello world!&quot;</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">FileOutputStream</span><span class="pln" style="color:rgb(0,0,0)"> outputStream</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">

</span><span class="kwd" style="color:rgb(0,0,136)">try</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; outputStream </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> openFileOutput</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">filename</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MODE_PRIVATE</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; outputStream</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">write</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getBytes</span><span class="pun" style="color:rgb(102,102,0)">());</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; outputStream</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">close</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">catch</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Exception</span><span class="pln" style="color:rgb(0,0,0)"> e</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; e</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">printStackTrace</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>再或者，如果你需要缓存一些文件，你应该使用<code>[createTempFile()](http://developer.android.com/reference/java/io/File.html#createTempFile(java.lang.String, java.lang.String))</code>。例如，下面的方法通过URL萃取文件名，同时使用这个文件名在内部缓存目录下创建一个文件：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> getTempFile</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pln" style="color:rgb(0,0,0)"> context</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> url</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> file</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">try</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> fileName </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Uri</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">parse</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">url</span><span class="pun" style="color:rgb(102,102,0)">).</span><span class="pln" style="color:rgb(0,0,0)">getLastPathSegment</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; file </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">createTempFile</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">fileName</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">null</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getCacheDir</span><span class="pun" style="color:rgb(102,102,0)">());</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">catch</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">IOException</span><span class="pln" style="color:rgb(0,0,0)"> e</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// Error while creating file</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> file</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p><strong>提示:</strong>&nbsp;你的app的内部存储目录是由你的app包名指定。从技术上来说，如果你把这个文件的模式设置为可读，那么其他app就能够访问你的app的内部文件了。然而，这些其他的app必须知道你的app的包名以及内部文件的名字。如果你不特别地自定内部文件的可读或可写模式，那么别的应用也没有权限操作你的app中的内部文件。</p>
<p>##<br>保存一个文件到外部存储</p>
<hr>
<p>由于外部存储可以不可用——例如当用户将其移除——你需要在访问它之前判断它是否可用。你可以通过调用<code>[getExternalStorageState()](http://developer.android.com/reference/android/os/Environment.html#getExternalStorageState())</code>方法查询到它的可用状态。如果该方法返回的状态等于<code>[MEDIA_MOUNTED](http://developer.android.com/reference/android/os/Environment.html#MEDIA_MOUNTED)</code>，那么你就能够读写你的文件。例如，下面的方法可用于判断外部存储是否可用：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="com">/* Checks if external storage is available for read and write */</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">boolean</span><span class="pln" style="color:rgb(0,0,0)"> isExternalStorageWritable</span><span class="pun" style="color:rgb(102,102,0)">()</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> state </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getExternalStorageState</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MEDIA_MOUNTED</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">equals</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">state</span><span class="pun" style="color:rgb(102,102,0)">))</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">false</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">

</span><span class="com">/* Checks if external storage is available to at least read */</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">boolean</span><span class="pln" style="color:rgb(0,0,0)"> isExternalStorageReadable</span><span class="pun" style="color:rgb(102,102,0)">()</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> state </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getExternalStorageState</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MEDIA_MOUNTED</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">equals</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">state</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">||</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MEDIA_MOUNTED_READ_ONLY</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">equals</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">state</span><span class="pun" style="color:rgb(102,102,0)">))</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">true</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">false</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>即使外部存储中的文件可以被用户或者其他app修改，对于下面两种类型的文件同样有合适的情况被保存在这里：</p>
<dl style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><dt>公共文件</dt><dd style="margin:0px 0px 10px 30px">需要被所有app或者用户访问到的文件。当你卸载你的app，你希望用户留下这些文件。<br><br>例如，你的app拍下的照片或者其他下载文件。<br><br></dd><dt>私有文件</dt><dd style="margin:0px 0px 10px 30px">文件隶属于你的app，并且应道在用户写在你的app是被删除。即使是这些文件在技术上来讲能够被用户或者其他app访问，实际上它在你的app外部是不会提供任何数据的。当你的app被卸载，系统将会删除你的app在外部存储中的所有私有目录。<br><br>例如，通过你的app下载的资源，或者临时的多媒体文件。<br><br></dd></dl>

<p>如果你希望在外部存储中保存公有文件，使用&nbsp;<code>[getExternalStoragePublicDirectory()](http://developer.android.com/reference/android/os/Environment.html#getExternalStoragePublicDirectory(java.lang.String))</code>&nbsp;方法来获得一个&nbsp;<code>[File](http://developer.android.com/reference/java/io/File.html)</code>&nbsp;对象。这个方法会接收一个参数作为对应文件类型要存放的位置。例如<code>[DIRECTORY_MUSIC](http://developer.android.com/reference/android/os/Environment.html#DIRECTORY_MUSIC)</code>&nbsp;或者&nbsp;<code>[DIRECTORY_PICTURES](http://developer.android.com/reference/android/os/Environment.html#DIRECTORY_PICTURES)</code></p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> getAlbumStorageDir</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> albumName</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="com">// Get the directory for the user's public pictures directory. </span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> file </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getExternalStoragePublicDirectory</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">DIRECTORY_PICTURES</span><span class="pun" style="color:rgb(102,102,0)">),</span><span class="pln" style="color:rgb(0,0,0)"> albumName</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(!</span><span class="pln" style="color:rgb(0,0,0)">file</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">mkdirs</span><span class="pun" style="color:rgb(102,102,0)">())</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">Log</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">e</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">LOG_TAG</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="str" style="color:rgb(136,0,0)">&quot;Directory not created&quot;</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> file</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>如果你想要在外部存储中保存私有文件，那么你可以通过调用<code>[getExternalFilesDir()](http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String))</code>&nbsp;方法来获取合适的文件目录对象，同时传入一个名字来指定目录的类型。每个通过这种方式调用获得的目录，都会在应用被卸载时被清除。</p>
<p>例如，下面是如何创建一个独立的相册目录：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="kwd" style="color:rgb(0,0,136)">public</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> getAlbumStorageDir</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pln" style="color:rgb(0,0,0)"> context</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">String</span><span class="pln" style="color:rgb(0,0,0)"> albumName</span><span class="pun" style="color:rgb(102,102,0)">)</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="com">// Get the directory for the app's private pictures directory. </span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pln" style="color:rgb(0,0,0)"> file </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="kwd" style="color:rgb(0,0,136)">new</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">File</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getExternalFilesDir</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">Environment</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">DIRECTORY_PICTURES</span><span class="pun" style="color:rgb(102,102,0)">),</span><span class="pln" style="color:rgb(0,0,0)"> albumName</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">if</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">(!</span><span class="pln" style="color:rgb(0,0,0)">file</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">mkdirs</span><span class="pun" style="color:rgb(102,102,0)">())</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="pun" style="color:rgb(102,102,0)">{</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ" style="color:rgb(102,0,102)">Log</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">e</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">LOG_TAG</span><span class="pun" style="color:rgb(102,102,0)">,</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="str" style="color:rgb(136,0,0)">&quot;Directory not created&quot;</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="pun" style="color:rgb(102,102,0)">}</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; </span><span class="kwd" style="color:rgb(0,0,136)">return</span><span class="pln" style="color:rgb(0,0,0)"> file</span><span class="pun" style="color:rgb(102,102,0)">;</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="pun" style="color:rgb(102,102,0)">}</span></pre>

<p>如果没有合适的预定义的子目录名字适合你的文件，你可以调用&nbsp;<code>[getExternalFilesDir()](http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String))</code>&nbsp;方法，同时传入<code>null</code>。它会返回外部存储中你的app对应的私有目录。</p>
<p>要记住通过&nbsp;<code>[getExternalFilesDir()](http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String))</code>&nbsp;方法创建的目录将会在app卸载时被删除。如果这些文件需要在应用卸载后被保存，当你的应用再次安装时能够访问到，你需要调用<code>[getExternalStoragePublicDirectory()](http://developer.android.com/reference/android/os/Environment.html#getExternalStoragePublicDirectory(java.lang.String))</code>方法。</p>
<p>不管你使用的是可分享的<code>[getExternalStoragePublicDirectory()](http://developer.android.com/reference/android/os/Environment.html#getExternalStoragePublicDirectory(java.lang.String))</code>&nbsp;方法，或者是私有的<code>[getExternalFilesDir()](http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String))</code>&nbsp;方法，使用系统所提供的目录名称（如&nbsp;<code>[DIRECTORY_PICTURES](http://developer.android.com/reference/android/os/Environment.html#DIRECTORY_PICTURES)</code>）都很重要。这些目录名称将确保这些文件在系统中会被按照这些方式对待。例如，保存在<code>[DIRECTORY_RINGTONES](http://developer.android.com/reference/android/os/Environment.html#DIRECTORY_RINGTONES)</code>&nbsp;中的文件将会被系统识别为手机铃声而非音乐。</p>
<p>##<br>查询剩余空间</p>
<hr>
<p>如果你知道你要保存的数据的大小，这样你就可以判断出是否有足够的空间避免导致&nbsp;<code>[IOException](http://developer.android.com/reference/java/io/IOException.html)</code>&nbsp;异常，可通过调用<code>[getFreeSpace()](http://developer.android.com/reference/java/io/File.html#getFreeSpace())</code>&nbsp;或者&nbsp;<code>[getTotalSpace()](http://developer.android.com/reference/java/io/File.html#getTotalSpace())</code>方法来获取剩余空间的大小。这两个方法各自返回此时的可用空间大侠和存储卷中总共的空间大小。这个方法同样可以在开始就避免占满整个存储空间。</p>
<p>然而，系统并不能确保你能够写入通过<code>[getFreeSpace()](http://developer.android.com/reference/java/io/File.html#getFreeSpace())</code>方法返回的数据大小。如果它返回的大小比你要写入的数据大小大几兆，或者文件系统还有90%的剩余空间，那么执行保存是安全的。否则，你不应该存储这些数据。</p>
<p><strong>提示:</strong>&nbsp;在存储文件前检查可用空间不是必须操作。你可以直接保存文件，然后捕获<code>[IOException](http://developer.android.com/reference/java/io/IOException.html)</code>&nbsp;异常。你可以在你不知道要保存的数据有多大时使用这种方法。例如，你在保存文件前将PNG转变成JPEG，改变了文件的编码，你提前并不知道文件的大小。</p>
<p>##<br>删除一个文件</p>
<hr>
<p>你要记得在文件不需要被使用时将其删除。最直接的删除方法调用文件对象的<code>[delete()](http://developer.android.com/reference/java/io/File.html#delete())</code>&nbsp;方法删除它本身。</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="pln" style="color:rgb(0,0,0)">myFile</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">delete</span><span class="pun" style="color:rgb(102,102,0)">();</span></pre>

<p>如果文件被保存在内部存储中，你同样可以使用Context定位然后调用<code>[deleteFile()](http://developer.android.com/reference/android/content/Context.html#deleteFile(java.lang.String))</code>方法删除文件：</p>
<p><pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="pln" style="color:rgb(0,0,0)">myContext</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">deleteFile</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">fileName</span><span class="pun" style="color:rgb(102,102,0)">);</span></pre></p>
<div class="note" style="margin:0px 0px 15px; padding:0px 0px 0px 10px; border-left-width:4px; border-left-style:solid; border-color:rgb(37,138,175); background-color:rgb(249,249,249)"><br><br><strong>提示:</strong>&nbsp;当用户卸载你的app，系统将会删除下面内容：<br><br><em>   所有你的app保存在内部存储中的数据
</em>   <code>&lt;span style=&quot;color:#222222&quot;&gt;&lt;span style=&quot;font-size:14px; line-height:19px&quot;&gt;所有通过调用&lt;/span&gt;&lt;/span&gt;[getExternalFilesDir()](http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String))</code><span style="font-family:Roboto,sans-serif; color:#222222"><span style="font-size:14px; line-height:19px">方法保存在外部存储中的数据。</span></span><br><br>然而，你手动删除通过<code>[getCacheDir()](http://developer.android.com/reference/android/content/Context.html#getCacheDir())</code>&nbsp;方法生成的文件，当这些文件不再需要被使用到时。<br><br></div>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/9/30 23:57:47 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38645095)
&lt;/div&gt;
&lt;div&gt;
阅读：582 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38645095#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/30/译-Android学习路线（二十六）Android数据存储/" itemprop="url">
                  [译]Android学习路线（二十六）Android数据存储
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-09-30T23:56:52+08:00" content="2014-09-30">
              2014-09-30
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>大部分的Android应用都需要保存数据，甚至是为了让用户在&nbsp;<code>[onPause()](http://developer.android.com/reference/android/app/Activity.html#onPause())</code>&nbsp;时不至于丢失数据都需要保存信息。大多数一般的app同样需要保存用户设置的数据，而一些app则必须在文件或是数据库中管理大量的账号信息。本课将向你介绍Android中数据存储的主要方式，包括：</p>
<ul>
<li>使用shared preferences文件通过键&#20540;对保存简单数据类型</li>
<li>保存任意的文件到Android的文件系统中</li>
<li>使用SQLite数据库</li>
</ul>
<p>##<br>课程</p>
<hr>
<dl style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)"><br><dt><strong><a href="http://developer.android.com/training/basics/data-storage/shared-preferences.html" target="_blank" rel="external">保存键&#20540;对集合</a></strong></dt><dd style="margin:0px 0px 10px 30px">学习使用shared preferences文件来通过键&#20540;对方式存储少量数据。</dd><dt><strong><a href="http://developer.android.com/training/basics/data-storage/files.html" target="_blank" rel="external">保存文件</a></strong></dt><dd style="margin:0px 0px 10px 30px">学习保存一个基本到文件，例如存储一个长序列并且通常会被顺序读取的数据。</dd><dt><strong><a href="http://developer.android.com/training/basics/data-storage/databases.html" target="_blank" rel="external">保存数据到数据库</a></strong></dt><dd style="margin:0px 0px 10px 30px">学习使用SQLite数据库读写结构化数据。</dd></dl>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/9/30 23:56:52 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38645041)
&lt;/div&gt;
&lt;div&gt;
阅读：482 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38645041#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/30/译-Android学习路线（二十七）键值对（SharedPreferences）存储/" itemprop="url">
                  [译]Android学习路线（二十七）键值对（SharedPreferences）存储
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-09-30T23:56:29+08:00" content="2014-09-30">
              2014-09-30
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>如果你又一个相对较小的键&#20540;对数据想要保存，你应该使用<code>[SharedPreferences](http://developer.android.com/reference/android/content/SharedPreferences.html)</code>&nbsp;APIs。一个<code>[SharedPreferences](http://developer.android.com/reference/android/content/SharedPreferences.html)</code>&nbsp;对象指向一个包含键&#20540;对的文件，它提供简单的方法来读写他们。每个<code>[SharedPreferences](http://developer.android.com/reference/android/content/SharedPreferences.html)</code>&nbsp;文件系统框架管理，它们可以是私有的也可以被共享。</p>
<p>本课将介绍如何使用<code>[SharedPreferences](http://developer.android.com/reference/android/content/SharedPreferences.html)</code>&nbsp;APIs来存储和获取简单的数据。</p>
<p><strong>提示:</strong>&nbsp;<code>[SharedPreferences](http://developer.android.com/reference/android/content/SharedPreferences.html)</code>&nbsp;APIs<br> 只能被用来操作键&#20540;对类型数据，不要把它和&nbsp;<code>[Preference](http://developer.android.com/reference/android/preference/Preference.html)</code>&nbsp;APIs弄混淆，Preference是用来帮助用户构建app设置界面的。更多关于&nbsp;<code>[Preference](http://developer.android.com/reference/android/preference/Preference.html)</code>&nbsp;APIs的信息，请移步<a href="http://developer.android.com/guide/topics/ui/settings.html" target="_blank" rel="external">Settings</a>&nbsp;向导。</p>
<p>##<br>获取SharedPreferences的引用（句柄）</p>
<p>你可以通过下面任意一种方式创建一个新的shared preference文件或者访问一个已经存在的shared preference文件：</p>
<ul>
<li><code>[getSharedPreferences()](http://developer.android.com/reference/android/content/Context.html#getSharedPreferences(java.lang.String, int))</code>&nbsp;—<br>Use this if you need multiple shared preference files identified by name, which you specify with the first parameter. You can call this from any&nbsp;<code>[Context](http://developer.android.com/reference/android/content/Context.html)</code>&nbsp;in<br>your app.</li>
<li><p><code>[getSharedPreferences()](http://developer.android.com/reference/android/content/Context.html#getSharedPreferences(java.lang.String, int))</code><span style="color:rgb(34,34,34); font-family:Roboto,sans-serif; font-size:14px; line-height:19px; background-color:rgb(249,249,249)">&nbsp;—<br>如果你通过不同的名字保存了多个shared preference文件，那么你可以使用这个方法，这个方法的第一个参数即为文件名。你可以在应用中使用Context对象来调用它。</span></p>
</li>
<li><p><code>[getPreferences()](http://developer.android.com/reference/android/app/Activity.html#getPreferences(int))</code>&nbsp;—<br>如果你只需要在这个activity中使用一个shared preference文件，那么你可以在activity中调用这个方法。因为这个方法会返回属于这个activity的一个默认的shared preference文件，你不需要为它提供一个名字。</p>
</li>
</ul>
<p>例如，以下的方法会在 &nbsp;<code>[Fragment](http://developer.android.com/reference/android/app/Fragment.html)</code>&nbsp;中被执行。它在内部访问了一个shared<br> preferences文件，这个文件被&nbsp;<code>R.string.preference_file_key</code>&nbsp;这个字符串指定，并且它是被私有模式（private mode）打开的，因此只能被你的app访问。</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pln" style="color:rgb(0,0,0)"> context </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getActivity</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">SharedPreferences</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getSharedPreferences</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">
&nbsp; &nbsp; &nbsp; &nbsp; getString</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">preference_file_key</span><span class="pun" style="color:rgb(102,102,0)">),</span><span class="pln" style="color:rgb(0,0,0)"> </span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MODE_PRIVATE</span><span class="pun" style="color:rgb(102,102,0)">);</span></pre>

<p>当为你的shared preference文件命名时，你应当使用一个唯一的标识，例如<code>&amp;quot;com.example.myapp.PREFERENCE_FILE_KEY&amp;quot;</code></p>
<p>作为替代，如果你只想要在你的activity中使用一个shared preference文件，你可以使用&nbsp;<code>[getPreferences()](http://developer.android.com/reference/android/app/Activity.html#getPreferences(int))</code>方法：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">SharedPreferences</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getActivity</span><span class="pun" style="color:rgb(102,102,0)">().</span><span class="pln" style="color:rgb(0,0,0)">getPreferences</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MODE_PRIVATE</span><span class="pun" style="color:rgb(102,102,0)">);</span></pre>

<p><strong>注意:</strong>&nbsp;如果你使用&nbsp;<code>[MODE_WORLD_READABLE](http://developer.android.com/reference/android/content/Context.html#MODE_WORLD_READABLE)</code>&nbsp;或者&nbsp;<code>[MODE_WORLD_WRITEABLE](http://developer.android.com/reference/android/content/Context.html#MODE_WORLD_WRITEABLE)</code>模式创建了一个shared<br> preference文件，那么任何其他知道这个文件标识的app都能够访问到你的数据。</p>
<p>##<br>向Shared Preferences中写入数据</p>
<hr>
<p>要向shared preferences文件中写入数据，你需要调用SharedPreferences的edit()方法来创建一个<a href="http://developer.android.com/reference/android/content/SharedPreferences.Editor.html" target="_blank" rel="external">SharedPreferences.Editor</a>&nbsp;对象。</p>
<p>传入键和&#20540;给你想要调用的方法，例如&nbsp;<code>[putInt()](http://developer.android.com/reference/android/content/SharedPreferences.Editor.html#putInt(java.lang.String, int))</code>&nbsp;和&nbsp;<code>[putString()](http://developer.android.com/reference/android/content/SharedPreferences.Editor.html#putString(java.lang.String, java.lang.String))</code>。然后调用<code>[commit()](http://developer.android.com/reference/android/content/SharedPreferences.Editor.html#commit())</code>&nbsp;方法来存储这些改变。例如：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">SharedPreferences</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getActivity</span><span class="pun" style="color:rgb(102,102,0)">().</span><span class="pln" style="color:rgb(0,0,0)">getPreferences</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MODE_PRIVATE</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="typ" style="color:rgb(102,0,102)">SharedPreferences</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="typ" style="color:rgb(102,0,102)">Editor</span><span class="pln" style="color:rgb(0,0,0)"> editor </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">edit</span><span class="pun" style="color:rgb(102,102,0)">();</span><span class="pln" style="color:rgb(0,0,0)">
editor</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">putInt</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getString</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">saved_high_score</span><span class="pun" style="color:rgb(102,102,0)">),</span><span class="pln" style="color:rgb(0,0,0)"> newHighScore</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
editor</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">commit</span><span class="pun" style="color:rgb(102,102,0)">();</span></pre>

<p>##<br>从Shared Preferences中读取数据</p>
<hr>
<p>要从shared preferences文件中获取数据，可以调用getInt()或者getString()等方法，只需要提供你想要获得的&#20540;对应的key就可以了；你也可以选择再传入一个默认&#20540;，如果通过传入的key没有取道&#20540;将会返回这个默认&#20540;。例如：</p>
<pre class="prettyprint" style="font-size:13px; margin-top:0px; margin-bottom:1em; color:rgb(0,102,0); line-height:1.5; padding:1em; overflow:auto; border:1px solid rgb(221,221,221); background:rgb(247,247,247)"><span class="typ" style="color:rgb(102,0,102)">SharedPreferences</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getActivity</span><span class="pun" style="color:rgb(102,102,0)">().</span><span class="pln" style="color:rgb(0,0,0)">getPreferences</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="typ" style="color:rgb(102,0,102)">Context</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">MODE_PRIVATE</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">int</span><span class="pln" style="color:rgb(0,0,0)"> defaultValue </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> getResources</span><span class="pun" style="color:rgb(102,102,0)">().</span><span class="pln" style="color:rgb(0,0,0)">getInteger</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">saved_high_score_default</span><span class="pun" style="color:rgb(102,102,0)">);</span><span class="pln" style="color:rgb(0,0,0)">
</span><span class="kwd" style="color:rgb(0,0,136)">long</span><span class="pln" style="color:rgb(0,0,0)"> highScore </span><span class="pun" style="color:rgb(102,102,0)">=</span><span class="pln" style="color:rgb(0,0,0)"> sharedPref</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">getInt</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">getString</span><span class="pun" style="color:rgb(102,102,0)">(</span><span class="pln" style="color:rgb(0,0,0)">R</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="kwd" style="color:rgb(0,0,136)">string</span><span class="pun" style="color:rgb(102,102,0)">.</span><span class="pln" style="color:rgb(0,0,0)">saved_high_score</span><span class="pun" style="color:rgb(102,102,0)">),</span><span class="pln" style="color:rgb(0,0,0)"> defaultValue</span><span class="pun" style="color:rgb(102,102,0)">);</span></pre>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/9/30 23:56:29 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38645065)
&lt;/div&gt;
&lt;div&gt;
阅读：765 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38645065#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/30/译-Android学习路线（二十九）保存数据到SQLite中/" itemprop="url">
                  [译]Android学习路线（二十九）保存数据到SQLite中
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-09-30T23:55:32+08:00" content="2014-09-30">
              2014-09-30
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="">对于可复用或者结构化的数据来说，把它们存储到数据库中是理想的方式。学习本课前你需要对通常的数据库有所了解，本课在此前提下会帮助你学习如何在android系统中操作SQLite数据库。你需要使用到的APIs都可以在<a href="http://developer.android.com/reference/android/database/sqlite/package-summary.html" target="_blank" rel="external"><span style="">android.database.sqlite</span></a>&nbsp;包中访问到。</span></p>
<p><span style="">定义一个&#26684;式和契约</span></p>
<p><span style=""></span></p>
<p><span style="">SQL数据库最主要的标准之一是其&#26684;式（Schema）：它用来声明数据库的组织。Schema可以通过你用来创建数据库的语句来表示。你会发现创建一个能够有条理地，明确指定schema布局的&quot;伙伴&quot;类(也被称为&quot;关系类&quot;)是非常有帮助的。</span></p>
<p><span style="">关系类其实就是个定义常量的容器，这些常量包含URIs,tables以及colums的名称。这个关系类允许你在同一个包下的所有类中都能够访问。这样的话，你只要在这里改变一个列名，你的所有代码都会受影响。</span></p>
<p><span style="">一个好的组织关系类的方法是，让你的关系类中对于整个数据库来说是全局可用的常量定义在关系类的顶级，然后为每个表在该类中建立内部类。</span></p>
<p><span style=""><strong>提示:</strong>&nbsp;通过实现&nbsp;<a href="http://developer.android.com/reference/android/provider/BaseColumns.html" target="_blank" rel="external"><span style="">BaseColumns</span></a>&nbsp;接口，你的内部类能够继承一个名称为</span><span style="">_ID</span><span style="">的属性，它在默写类(例如cursor<br> adapter)中被期望存在。它不是必须的，但是如果它的存在能够让你的数据库和Android框架相处更加和谐。</span></p>
<p><span style="">例如，下面的代码片段定义了一个表的表明和列名：</span></p>
<p><span style="">public</span><span style=""> </span><span style="">final</span><span style=""><br></span><span style="">class</span><span style=""> </span><span style="">FeedReaderContract</span><span style=""><br></span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">// To prevent someone from accidentally instantiating the contract class,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">// give it an empty constructor.</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">FeedReaderContract</span><span style="">()</span><span style=""><br></span><span style="">{}</span></p>
<p><span style=""></span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">/<em> Inner class that defines the table contents </em>/</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">abstract</span><span style=""> </span><span style="">class</span><span style=""><br></span><span style="">FeedEntry</span><span style=""> </span><span style="">implements</span><span style=""><br></span><span style="">BaseColumns</span><span style=""> </span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><br><span style="">static</span><span style=""> </span><span style="">final</span><span style=""><br></span><span style="">String</span><span style=""> TABLE_NAME </span><span style="">=</span><span style=""><br></span><span style="">&quot;entry&quot;</span><span style="">;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><br><span style="">static</span><span style=""> </span><span style="">final</span><span style=""><br></span><span style="">String</span><span style=""> COLUMN_NAME_ENTRY_ID </span><span style="">=</span><span style=""><br></span><span style="">&quot;entryid&quot;</span><span style="">;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><br><span style="">static</span><span style=""> </span><span style="">final</span><span style=""><br></span><span style="">String</span><span style=""> COLUMN_NAME_TITLE </span><span style="">=</span><span style=""><br></span><span style="">&quot;title&quot;</span><span style="">;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><br><span style="">static</span><span style=""> </span><span style="">final</span><span style=""><br></span><span style="">String</span><span style=""> COLUMN_NAME_SUBTITLE </span><span style="">=</span><span style=""><br></span><span style="">&quot;subtitle&quot;</span><span style="">;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">…</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">}</span></p>
<p><span style="">}</span></p>
<p><span style="">通过SQL Helper创建一个数据库</span></p>
<p><span style=""></span></p>
<p><span style="">一旦你定义了你的数据库的样子，你就需要实现一些方法来创建和保持数据库和表。下面是创建和删除一个表的典型的语句：</span></p>
<p><span style="">private</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">String</span><span style=""> TEXT_TYPE<br></span><span style="">=</span><span style=""> </span><span style="">&quot; TEXT&quot;</span><span style="">;</span></p>
<p><span style="">private</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">String</span><span style=""> COMMA_SEP<br></span><span style="">=</span><span style=""> </span><span style="">&quot;,&quot;</span><span style="">;</span></p>
<p><span style="">private</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">String</span><span style=""> SQL_CREATE_ENTRIES<br></span><span style="">=</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">&quot;CREATE TABLE &quot;</span><span style=""> </span><br><span style="">&#43;</span><span style=""> </span><span style="">FeedEntry</span><span style="">.</span><span style="">TABLE_NAME<br></span><span style="">&#43;</span><span style=""> </span><span style="">&quot; (&quot;</span><span style=""><br></span><span style="">&#43;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">_ID<br></span><span style="">&#43;</span><span style=""> </span><span style="">&quot; INTEGER PRIMARY KEY,&quot;</span><span style=""><br></span><span style="">&#43;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_ENTRY_ID<br></span><span style="">&#43;</span><span style=""> TEXT_TYPE </span><span style="">&#43;</span><span style=""> COMMA_SEP<br></span><span style="">&#43;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_TITLE<br></span><span style="">&#43;</span><span style=""> TEXT_TYPE </span><span style="">&#43;</span><span style=""> COMMA_SEP<br></span><span style="">&#43;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">…</span><span style=""> </span><span style="">// Any other options for the CREATE command</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">&quot; )&quot;</span><span style="">;</span></p>
<p><span style=""></span></p>
<p><span style="">private</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">String</span><span style=""> SQL_DELETE_ENTRIES<br></span><span style="">=</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">&quot;DROP TABLE IF EXISTS &quot;</span><span style=""><br></span><span style="">&#43;</span><span style=""> </span><span style="">FeedEntry</span><span style="">.</span><span style="">TABLE_NAME</span><span style="">;</span></p>
<p><span style="">就像是你保存在内部存储中的文件一样，Android将你的数据库存储在和应用关联的私有空间内。你的数据是安全的，因为默认这个区域不能被其他的app访问。</span></p>
<p><span style="">在&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html" target="_blank" rel="external"><span style="">SQLiteOpenHelper</span></a>&nbsp;类中能够找到很多有用的API。当你使用这个类来获得数据库的引用时，系统只会在需要的时候才会去做这种可能长时间的创建/更新数据酷的操作，而不会在app启动时这样做。你所需要做的只有调用&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#getWritableDatabase(" target="_blank" rel="external"><span style="">getWritableDatabase()</span></a>)&nbsp;或者<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#getReadableDatabase(" target="_blank" rel="external"><span style="">getReadableDatabase()</span></a>)。</span></p>
<p><span style=""><strong>提示:</strong>&nbsp;由于这可能会很长时间，确保要在后台线程中调用&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#getWritableDatabase(" target="_blank" rel="external"><span style="">getWritableDatabase()</span></a>)&nbsp;或者<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#getReadableDatabase(" target="_blank" rel="external"><span style="">getReadableDatabase()</span></a>)&nbsp;方法，例如在&nbsp;<a href="http://developer.android.com/reference/android/os/AsyncTask.html" target="_blank" rel="external"><span style="">AsyncTask</span></a>&nbsp;或者&nbsp;<a href="http://developer.android.com/reference/android/app/IntentService.html" target="_blank" rel="external"><span style="">IntentService</span></a>中。</span></p>
<p><span style="">在使用<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html" target="_blank" rel="external"><span style="">SQLiteOpenHelper</span></a>时，创建一个它的子类，实现&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#onCreate(android.database.sqlite.SQLiteDatabase" target="_blank" rel="external"><span style="">onCreate()</span></a>)</span><span style="">，</span><span style="">&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#onUpgrade(android.database.sqlite.SQLiteDatabase,%20int,%20int" target="_blank" rel="external"><span style="">onUpgrade()</span></a>)&nbsp;和<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#onOpen(android.database.sqlite.SQLiteDatabase" target="_blank" rel="external"><span style="">onOpen()</span></a>)&nbsp;回调方法。你可能还想实现<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html#onDowngrade(android.database.sqlite.SQLiteDatabase,%20int,%20int" target="_blank" rel="external"><span style="">onDowngrade()</span></a>)方法，但是它并不是必须的。</span></p>
<p><span style="">例如，下面展示了如何实现&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html" target="_blank" rel="external"><span style="">SQLiteOpenHelper</span></a>&nbsp;类，使用上面的一些命令：</span></p>
<p><span style="">public</span><span style=""> </span><span style="">class</span><span style=""><br></span><span style="">FeedReaderDbHelper</span><span style=""> </span><span style="">extends</span><span style=""><br></span><span style="">SQLiteOpenHelper</span><span style=""> </span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">// If you change the database schema, you must increment the database version.</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">int</span><span style=""> DATABASE_VERSION<br></span><span style="">=</span><span style=""> </span><span style="">1</span><span style="">;</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">static</span><span style=""><br></span><span style="">final</span><span style=""> </span><span style="">String</span><span style=""> DATABASE_NAME<br></span><span style="">=</span><span style=""> </span><span style="">&quot;FeedReader.db&quot;</span><span style="">;</span></p>
<p><span style=""></span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">FeedReaderDbHelper</span><span style="">(</span><span style="">Context</span><span style=""> context</span><span style="">)</span><span style=""><br></span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">super</span><span style="">(</span><span style="">context</span><span style="">,</span><span style=""> DATABASE_NAME</span><span style="">,</span><span style=""><br></span><span style="">null</span><span style="">,</span><span style=""> DATABASE_VERSION</span><span style="">);</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">}</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">void</span><span style=""> onCreate</span><span style="">(</span><span style="">SQLiteDatabase</span><span style=""> db</span><span style="">)</span><span style=""><br></span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db</span><span style="">.</span><span style="">execSQL</span><span style="">(</span><span style="">SQL_CREATE_ENTRIES</span><span style="">);</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">}</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">void</span><span style=""> onUpgrade</span><span style="">(</span><span style="">SQLiteDatabase</span><span style=""> db</span><span style="">,</span><span style=""><br></span><span style="">int</span><span style=""> oldVersion</span><span style="">,</span><span style=""><br></span><span style="">int</span><span style=""> newVersion</span><span style="">)</span><span style=""><br></span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">// This database is only a cache for online data, so its upgrade policy is</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">// to simply to discard the data and start over</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db</span><span style="">.</span><span style="">execSQL</span><span style="">(</span><span style="">SQL_DELETE_ENTRIES</span><span style="">);</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; onCreate</span><span style="">(</span><span style="">db</span><span style="">);</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">}</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">public</span><span style=""> </span><span style="">void</span><span style=""> onDowngrade</span><span style="">(</span><span style="">SQLiteDatabase</span><span style=""> db</span><span style="">,</span><span style=""><br></span><span style="">int</span><span style=""> oldVersion</span><span style="">,</span><span style=""><br></span><span style="">int</span><span style=""> newVersion</span><span style="">)</span><span style=""><br></span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; onUpgrade</span><span style="">(</span><span style="">db</span><span style="">,</span><span style=""> oldVersion</span><span style="">,</span><span style=""> newVersion</span><span style="">);</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">}</span></p>
<p><span style="">}</span></p>
<p><span style="">要访问你的数据库，实例化你所创建的<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html" target="_blank" rel="external"><span style="">SQLiteOpenHelper</span></a>的子类：</span></p>
<p><span style="">FeedReaderDbHelper</span><span style=""> mDbHelper </span><span style="">=</span><span style=""><br></span><span style="">new</span><span style=""> </span><span style="">FeedReaderDbHelper</span><span style="">(</span><span style="">getContext</span><span style="">());</span></p>
<p><span style="">向数据库中插入数据</span></p>
<p><span style=""></span></p>
<p><span style="">通过将&nbsp;<a href="http://developer.android.com/reference/android/content/ContentValues.html" target="_blank" rel="external"><span style="">ContentValues</span></a>&nbsp;对象传给<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteDatabase.html#insert(java.lang.String,%20java.lang.String,%20android.content.ContentValues" target="_blank" rel="external"><span style="">insert()</span></a>)&nbsp;方法来向数据库中插入数据：</span></p>
<p><span style="">// Gets the data repository in write mode</span></p>
<p><span style="">SQLiteDatabase</span><span style=""> db </span><span style="">=</span><span style=""> mDbHelper</span><span style="">.</span><span style="">getWritableDatabase</span><span style="">();</span></p>
<p><span style=""></span></p>
<p><span style="">// Create a new map of values, where column names are the keys</span></p>
<p><span style="">ContentValues</span><span style=""> values </span><span style="">=</span><span style=""><br></span><span style="">new</span><span style=""> </span><span style="">ContentValues</span><span style="">();</span></p>
<p><span style="">values</span><span style="">.</span><span style="">put</span><span style="">(</span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_ENTRY_ID</span><span style="">,</span><span style=""> id</span><span style="">);</span></p>
<p><span style="">values</span><span style="">.</span><span style="">put</span><span style="">(</span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_TITLE</span><span style="">,</span><span style=""> title</span><span style="">);</span></p>
<p><span style="">values</span><span style="">.</span><span style="">put</span><span style="">(</span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_CONTENT</span><span style="">,</span><span style=""> content</span><span style="">);</span></p>
<p><span style=""></span></p>
<p><span style="">// Insert the new row, returning the primary key value of the new row</span></p>
<p><span style="">long</span><span style=""> newRowId</span><span style="">;</span></p>
<p><span style="">newRowId </span><span style="">=</span><span style=""> db</span><span style="">.</span><span style="">insert</span><span style="">(</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">TABLE_NAME</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_NULLABLE</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; values</span><span style="">);</span></p>
<p><span style=""><a href="http://developer.android.com/reference/android/database/sqlite/SQLiteDatabase.html#insert(java.lang.String,%20java.lang.String,%20android.content.ContentValues" target="_blank" rel="external">insert()</a>)</span><span style="">&nbsp;方法的第一个参数是“表名”。第二个参数将提供一些列名，当<a href="http://developer.android.com/reference/android/content/ContentValues.html" target="_blank" rel="external"><span style="">ContentValues</span></a>&nbsp;为空时，framework会给这些列插入NULL（如果你给这个参数传null，当没有&#20540;时，framework将不会插入）。</span></p>
<p><span style="">从数据库中读取数据</span></p>
<p><span style=""></span></p>
<p><span style="">要从数据库中读取数据，使用&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteDatabase.html#query(boolean,%20java.lang.String,%20java.lang.String%5B%5D,%20java.lang.String,%20java.lang.String%5B%5D,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String" target="_blank" rel="external"><span style="">query()</span></a>)&nbsp;方法，向它传入插叙条件以及需要返回的列。查询的结果将会通过Cursor对象返回：</span></p>
<p><span style="">SQLiteDatabase</span><span style=""> db </span><span style="">=</span><span style=""> mDbHelper</span><span style="">.</span><span style="">getReadableDatabase</span><span style="">();</span></p>
<p><span style=""></span></p>
<p><span style="">// Define a <em>projection</em> that specifies which columns from the database</span></p>
<p><span style="">// you will actually use after this query.</span></p>
<p><span style="">String</span><span style="">[]</span><span style=""> projection </span><br><span style="">=</span><span style=""> </span><span style="">{</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">_ID</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_TITLE</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_UPDATED</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">…</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">};</span></p>
<p><span style=""></span></p>
<p><span style="">// How you want the results sorted in the resulting Cursor</span></p>
<p><span style="">String</span><span style=""> sortOrder </span><span style="">=</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_UPDATED<br></span><span style="">&#43;</span><span style=""> </span><span style="">&quot; DESC&quot;</span><span style="">;</span></p>
<p><span style=""></span></p>
<p><span style="">Cursor</span><span style=""> c </span><span style="">=</span><span style=""> db</span><span style="">.</span><span style="">query</span><span style="">(</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedEntry</span><span style="">.</span><span style="">TABLE_NAME</span><span style="">,</span><span style="">&nbsp;<br></span><span style="">// The table to query</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; projection</span><span style="">,</span><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span style="">// The columns to return</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; selection</span><span style="">,</span><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span style="">// The columns for the WHERE clause</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; selectionArgs</span><span style="">,</span><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span style="">// The values for the WHERE clause</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">null</span><span style="">,</span><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span style="">// don’t group the rows</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">null</span><span style="">,</span><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span style="">// don’t filter by row groups</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; sortOrder&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="">// The sort order</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">);</span></p>
<p><span style="">要查看cursor中的数据，你每一次读取前都需要使用cursor的一个方法。一般来说，你需要在开始时调用&nbsp;<a href="http://developer.android.com/reference/android/database/Cursor.html#moveToFirst(" target="_blank" rel="external"><span style="">moveToFirst()</span></a>)方法，它会将游标指向 结果集中的第一项。Cursor中的每一行（row）数据你都可以调用Cursor中的一种get方法，例如&nbsp;<a href="http://developer.android.com/reference/android/database/Cursor.html#getString(int" target="_blank" rel="external"><span style="">getString()</span></a>)&nbsp;或者&nbsp;<a href="http://developer.android.com/reference/android/database/Cursor.html#getLong(int" target="_blank" rel="external"><span style="">getLong()</span></a>)。每个get方法都需要传递一个当前列的索引，你可以通过调用&nbsp;<a href="http://developer.android.com/reference/android/database/Cursor.html#getColumnIndex(java.lang.String" target="_blank" rel="external"><span style="">getColumnIndex()</span></a>)&nbsp;或者&nbsp;<a href="http://developer.android.com/reference/android/database/Cursor.html#getColumnIndexOrThrow(java.lang.String" target="_blank" rel="external"><span style="">getColumnIndexOrThrow()</span></a>)方法来获得索引。例如：</span></p>
<p><span style="">cursor</span><span style="">.</span><span style="">moveToFirst</span><span style="">();</span></p>
<p><span style="">long</span><span style=""> itemId </span><span style="">=</span><span style=""> cursor</span><span style="">.</span><span style="">getLong</span><span style="">(</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; cursor</span><span style="">.</span><span style="">getColumnIndexOrThrow</span><span style="">(</span><span style="">FeedEntry</span><span style="">.</span><span style="">_ID</span><span style="">)</span></p>
<p><span style="">);</span></p>
<p><span style="">删除数据库中的数据</span></p>
<p><span style=""></span></p>
<p><span style="">要从表中删除一行数据，你需要提供能够定位到这一行的查询条件。数据库的API提供了一种能够阻止SQL注入的创建查询条件的机制。 这个机制将查询条件以及查询参数分离。（The mechanism divides the selection specification into a selection clause and selection arguments. The clause defines the columns to look at, and also allows you<br> to combine column tests. The arguments are values to test against that are bound into the clause.） 由于这种机制产生的结果不是常规的SQL语句，它有效地防止了SQL注入。</span></p>
<p><span style="">// Define ‘where’ part of query.</span></p>
<p><span style="">String</span><span style=""> selection </span><span style="">=</span><span style=""><br></span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_ENTRY_ID<br></span><span style="">&#43;</span><span style=""> </span><span style="">&quot; LIKE ?&quot;</span><span style="">;</span></p>
<p><span style="">// Specify arguments in placeholder order.</span></p>
<p><span style="">String</span><span style="">[]</span><span style=""> selectionArgs<br></span><span style="">=</span><span style=""> </span><span style="">{</span><span style=""><br></span><span style="">String</span><span style="">.</span><span style="">valueOf</span><span style="">(</span><span style="">rowId</span><span style="">)</span><span style=""><br></span><span style="">};</span></p>
<p><span style="">// Issue SQL statement.</span></p>
<p><span style="">db</span><span style="">.</span><span style="">delete</span><span style="">(</span><span style="">table_name</span><span style="">,</span><span style=""> selection</span><span style="">,</span><span style=""> selectionArgs</span><span style="">);</span></p>
<p><span style="">更新数据库</span></p>
<p><span style=""></span></p>
<p><span style="">当你需要修改数据库中的数据时，使用&nbsp;<a href="http://developer.android.com/reference/android/database/sqlite/SQLiteDatabase.html#update(java.lang.String,%20android.content.ContentValues,%20java.lang.String,%20java.lang.String%5B%5D" target="_blank" rel="external"><span style="">update()</span></a>)&nbsp;方法。</span></p>
<p><span style="">SQLiteDatabase</span><span style=""> db </span><span style="">=</span><span style=""> mDbHelper</span><span style="">.</span><span style="">getReadableDatabase</span><span style="">();</span></p>
<p><span style=""></span></p>
<p><span style="">// New value for one column</span></p>
<p><span style="">ContentValues</span><span style=""> values </span><span style="">=</span><span style=""><br></span><span style="">new</span><span style=""> </span><span style="">ContentValues</span><span style="">();</span></p>
<p><span style="">values</span><span style="">.</span><span style="">put</span><span style="">(</span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_TITLE</span><span style="">,</span><span style=""> title</span><span style="">);</span></p>
<p><span style=""></span></p>
<p><span style="">// Which row to update, based on the ID</span></p>
<p><span style="">String</span><span style=""> selection </span><span style="">=</span><span style=""><br></span><span style="">FeedEntry</span><span style="">.</span><span style="">COLUMN_NAME_ENTRY_ID<br></span><span style="">&#43;</span><span style=""> </span><span style="">&quot; LIKE ?&quot;</span><span style="">;</span></p>
<p><span style="">String</span><span style="">[]</span><span style=""> selectionArgs<br></span><span style="">=</span><span style=""> </span><span style="">{</span><span style=""><br></span><span style="">String</span><span style="">.</span><span style="">valueOf</span><span style="">(</span><span style="">rowId</span><span style="">)</span><span style=""><br></span><span style="">};</span></p>
<p><span style=""></span></p>
<p><span style="">int</span><span style=""> count </span><span style="">=</span><span style=""> db</span><span style="">.</span><span style="">update</span><span style="">(</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; </span><span style="">FeedReaderDbHelper</span><span style="">.</span><span style="">FeedEntry</span><span style="">.</span><span style="">TABLE_NAME</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; values</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; selection</span><span style="">,</span></p>
<p><span style="">&nbsp;&nbsp;&nbsp; selectionArgs</span><span style="">);</span></p>
<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/9/30 23:55:32 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38645119)
&lt;/div&gt;
&lt;div&gt;
阅读：575 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38645119#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/27/原-Android学习路线（二十五）全面理解Android-Navigation逻辑/" itemprop="url">
                  [原]Android学习路线（二十五）全面理解Android Navigation逻辑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-08-27T01:23:17+08:00" content="2014-08-27">
              2014-08-27
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="font-size:14px"></span></p>
<p><span style="font-size:14px">转载请注明出处：<a href="http://blog.csdn.net/sweetvvck/article/details/38832809" target="_blank" rel="external">Android学习路线（二十五）全面理解Android Navigation逻辑</a></span></p>
<p><span style="font-size:14px">应用导航的一致性是整体用户体验的重要组成部分，如果app的导航方式不一样，用户不能很快理解，那么这个应用会让用户有很大的挫败感，大大地影响了用户体验。</span></p>
<p><span style="font-size:14px">Android 3.0后，系统像大家介绍了其在全局导航表现上的重大改变。全面地理解“Back”以及“Up”的导航效果以及意义，能够大大地减少用户的学习时间，用户在使用过程中很快能够学习如何在应用的各个界面间的切换。</span></p>
<p><span style="font-size:14px">Android 2.3以及它之前的系统都是通过“Back”按钮来为app导航的。在Android 3.0后出现的Actionbar则带来了另一种一致性的导航方式：“Up”，它位于Actionbar的最左边，通常由应用的Icon以及Title组成。</span></p>
<p><span style="font-size:14px">下图分别展示了“Back”和“Up”的示例：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140826002202399?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<h1 id="Up_vs-_Back"><a href="#Up_vs-_Back" class="headerlink" title="Up vs. Back"></a>Up vs. Back</h1><hr>
<p><span style="font-size:14px">Up的导航逻辑是根据界面的层次结构决定的。例如A界面有一个列表，点击列表的Item进入B界面，这个时候，在B界面应该要提供一个Up按钮，点击Up则应该返回到A界面。</span></p>
<p><span style="font-size:14px">如果一个界面是app的主界面，则这个界面是不需要提供Up按钮的，而Back按钮在所有的界面都会起作用。</span></p>
<p><span style="font-size:14px">在应用中，Back的作用是返回到上一个界面中。如果把一个一个打开界面看成是入栈，那么点击Back按钮无疑代表着出栈，用户应该总是能够通过back操作找到上一个界面。</span></p>
<p><span style="font-size:14px">如果当前界面的上一个界面正好也是当前界面的父级界面，那么Back和Up的效果是同样的。但是，Up主要是在app内部使用，而Back则能够让用户回到手机的主界面，甚至能够回到其他的app中。</span></p>
<p><span style="font-size:14px">举个简单的例子：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140826003932624?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">在手机的主界面点击Gmail应用，进入到Gmail主界面中，主界面包含邮件的会话列表，点击其中一个会话会进入会话的详情界面。在会话详情页上，上一个界面和该界面的上级界面都是会话列表界面，因此点击Back和Up的效果是相同的，都会回到会话列表界面。可以发现，会话列表式Gmail的主界面，所以这个界面上是没有Up按钮的，这个时候则可以通过点击Back回到手机的主界面上。</span></p>
<p><span style="font-size:14px">Back除了能够处理这些界面间的切换，同时它还能处理一些统一界面上的导航逻辑，例如：</span></p>
<p><span style="font-size:14px">点击Back能够让当前界面的对话框消失，还能解除当前界面的文字高亮，同时它还能隐藏输入键盘等。</span></p>
<h2 id="u5355_u4E2A_u5E94_u7528_u5185_u90E8_u5BFC_u822A"><a href="#u5355_u4E2A_u5E94_u7528_u5185_u90E8_u5BFC_u822A" class="headerlink" title="单个应用内部导航"></a><span style="font-size:18px">单个应用内部导航</span></h2><p><span style="font-size:14px">当一个界面有很多入口时，在这个界面点击Up按钮应该回到进入到这个界面的相关界面，这样的效果和Back回到上一个界面的效果是相同的。例如设置界面，应用中可能有很多地方能够进入设置界面，此时点击Up和Back都会返回它的上一个界面。</span></p>
<p><span style="font-size:14px">如果在一个界面内切换视图，例如一个界面包含ViewPager，虽然左右滑动导致界面上的视图更改，但是此界面在app的界面层级并没有改变，同时也没有创建新的导航历史，因此这样的操作时不会引起Up和Back有新 的行为的。</span></p>
<p><span style="font-size:14px">例如：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140826010627726?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">在会话列表界面点击了其中一条会话，进入详情，在详情页左右滑动查看前后会话详情内容；但是此操作并没有切换界面（在app界面中的层级），因此这样并不能影响Back和Up的效果。</span></p>
<p><span style="font-size:14px">然而，如果在详情页点击了某个按钮进入了另一个详情界面，并且此时创建了导航历史。这样的话，点击Back会回到该详情页的上一个界面，而点击Up则会回到该界面在app中层级的上一级界面。</span></p>
<p><span style="font-size:14px">例如：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140826011742859?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">我们还可以让导航更加智能，比如我们在某个种类的列表界面点击Item进入详情页跳转到另一种类型的详情页，这时点击Back界面会转到上一个详情页，而点击Up则会返回到这种类型的列表页；如下图所示：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140827003353545?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">上过上面的讲解，我们可以大致了解Back和Up的不同作用与目的。用户进入到App，切换不同的界面，每个界面都会被加入到一个栈里，通常情况下Back的作用是返回到栈中的上一个界面；而Up与这个栈没有直接关系，除了应用主界面，其他界面都会有一个父级界面，Up的作用正是返回到当前界面的父级界面。</span></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px">然而，有些情况为了让Back的效果有更好的可预测性，我们应到手动向Back的界面栈中添加界面，这样用户就能更清楚是如何进入到当前界面的。例如，当点击Android桌面上的Widgets进入到一个非app主界面中，如果没有向界面栈中手动插入app的主界面，点击返回就直接退到了手机Home界面，这样的体验不太好；因此我们会做手动向栈中插入界面的操作。详情如下图所示：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140827004907843?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<h2 id="u8DE8_u5E94_u7528_u5BFC_u822A"><a href="#u8DE8_u5E94_u7528_u5BFC_u822A" class="headerlink" title="跨应用导航"></a><strong><span style="font-size:18px">跨应用导航</span></strong></h2><p><span style="font-size:14px">在同一个App中Back和Up各司其职，有相同的地方也有不同的地方；而在夸应用的情况下，Back和Up有更多的不同之处。</span></p>
<p><span style="font-size:14px">要知道Back和Up跨App的导航效果，首先要知道下面三个概念：</span></p>
<p><span style="font-size:14px">Activities：我们都知道，一个Activity是一个展示信息界面与用户交互的应用组件，而一个app可以看成包含多个activities的集合；而这些activities可以是app自身定义的也可以是对其他app中activity的重用；</span></p>
<p><span style="font-size:14px">Task：Task表示用户一次完整操作的流程。例如用户打开某个应用，在应用的某个界面中点击分享内容，选择通过邮件方式分享；这样的一个过程称为task，可以看到这个过程是跨app的，这次task包含多个activities；</span></p>
<p><span style="font-size:14px">Intent：Intent表示界面跳转的意图，可以指定界面跳转，也可以根据界面支持的action跳转。例如系统中“Share”这个Intent，它会列出系统中所有支持分享的app；</span></p>
<p><span style="font-size:14px">了解了上面的概念后我们来看看这个例子：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140827011051401?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">用户在某个界面点击分享，跳转到Gmail中分享内容，这个过程是一个task，此时如果点击Back，则会返回到之前的app中；而如果点击Up，则会留在Gmail中，并且跳转到Gmail的主界面（当前界面的父级界面），这个过程是一个新的task。这个新的task会把老的task给覆盖掉，点击Back则返回系统Home界面。</span></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px">纵观全文，我们了解到了系统推荐的导航准则。我们可以按照规范来，但是在我们的app中，我们也可以具体情况具体分析，总之一个原则就是让用户更快地学习使用app，让界面的导航有更好的可预测性。</span></p>
<p><span style="font-size:14px">本文大致解释了新版Android系统推荐的导航机制，想了解更加细致的内容请参考：<a href="http://developer.android.com/design/patterns/navigation.html" target="_blank" rel="external">Navigation with Back and Up</a>&nbsp;。本人也会在后续的文章中介绍ActionBar如何实现Up导航。</span></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/8/27 1:23:17 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38832809)
&lt;/div&gt;
&lt;div&gt;
阅读：2657 评论：10 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38832809#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/26/原-Zookeeper集群搭建/" itemprop="url">
                  [原]Zookeeper集群搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-08-26T10:05:51+08:00" content="2014-08-26">
              2014-08-26
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="font-size:14px">Zookeeper是Apache的一个开源项目，在集群管理中十分常用。它的集群搭建也十分简单，只需要简单的配置，集群的各个节点会完成自行通讯，自动选取Leader等。</span></p>
<p><span style="font-size:14px">更多关于zookeeper的信息和原理，可以参考这篇博文：<a href="http://blog.csdn.net/sweetvvck/article/details/38262965" target="_blank" rel="external">ZooKeeper原理及使用</a></span></p>
<div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>Zookeeper的单机模式更加简单：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>&nbsp; &nbsp; &nbsp; 在Ubuntu系统下，只需要执行sudo apt-get install zookeeper安装，然后到安装目录下找到zkServer.sh脚本，执行./zkServer.sh start就启动了zookeeper的单机模式，通过这种方式安装的zookeeper的目录通常是/usr/share/zookeeper/。通过执行zkServer.sh status可以看到zookeeper的运行状态，这里使用的是单机模式，则会显示：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">JMX enabled by default<br>Using config: /etc/zookeeper/conf/zoo.cfg<br>Mode: standalone</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>&nbsp; &nbsp; &nbsp; 如果是在其他的Linux系统（CentOS）上，执行：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">wget <a href="http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz" target="_blank" rel="external">http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz</a><br>tar zxf zookeeper-3.4.6.tar.gz<br>cd zookeeper-3.4.6/conf/</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>这个目录下有一个zoo_sample.cfg文件，是官方提供的示例配置，执行：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">cp ./zoo_sample.cfg zoo.cfg</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>复制一份示例配置，改名为zoo.cfg，启动zookeeper：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">../bin/zkServer.sh start</pre><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>下面我们来尝试一下搭建zookeeper集群，由于机器有限，我采用在一台机器上搭建伪集群的方式来搭建集群。</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>zookeeper官方推荐集群的节点数要是奇数，因此我们这里准备搭建3个节点的集群。</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>首先，创建三个文件夹分别表示三个节点：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">mkdir server0<br>mkdir server1<br>mkdir server2</pre><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>然后将下载好的zookeeper文件解压到每个目录下：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">tar xzvf zookeeper-3.4.6.tar.gz -C ./server0/<br>tar xzvf zookeeper-3.4.6.tar.gz -C ./server1/<br>tar xzvf zookeeper-3.4.6.tar.gz -C ./server2/</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><span style="line-height:1.428571em">同时更改目录名称：</span></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">mv ./server0/zookeeper-3.4.6 ./server0/zookeeper<br>mv ./server1/zookeeper-3.4.6 ./server1/zookeeper<br>mv ./server2/zookeeper-3.4.6 ./server2/zookeeper</pre><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>然后进入到每个节点的zookeeper目录下，分别创建data目录以及logs目录：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">mkdir data<br>mkdir logs</pre><br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>然后在data目录下创建myid文件，内容为当前节点的序号，如0,1,2：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">vim ./data/myid</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>填入序号，保存；</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>接下来进入conf目录创建zoo.cfg文件：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">vim ./zoo.cfg</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>内容按下面方式填写：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>tickTime=2000&nbsp;<br><br>initLimit=5&nbsp;<br><br>syncLimit=2&nbsp;<br><br>dataDir=/opt/<span style="color:#ff0000">server0</span>/zookeeper/data&nbsp;<br><br>dataLogDir=/opt/<span style="color:#ff0000">server0</span>/zookeeper/logs&nbsp;<br><br>clientPort=<span style="color:#ff0000">2180</span><br><br>server.0=127.0.0.1:8880:7770&nbsp;<br><br>server.1=127.0.0.1:8881:7771&nbsp;<br><br>server.2=127.0.0.1:8882:7772<br><br></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>其中标红的部分要根据当前节点序号进行修改，例如当前在server0目录下，则按照上面的配置填写，然后保存。</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>填写完配置后就可以启动zookeeper了：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">./bin/zkServer.sh start</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>然后在另外两个节点的目录下重复上述操作，伪集群就搭建好啦。</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>通过./bin/zkServer.sh status可以看到当前节点在集群中的角色，显示如下：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">JMX enabled by default<br>Using config: /opt/zookeeper/server0/zookeeper/bin/../conf/zoo.cfg<br>Mode: follower</pre></div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br>通过./bin/zkCli.sh -server host:port的方式能够指定任一一个节点访问到集群：</div><br><div style="margin:0px; padding:0px; border:0px; line-height:1.428571em; font-family:Helvetica,Arial,'Droid Sans',sans-serif; font-size:14px"><br><pre name="code" class="plain">./bin/zkCli.sh -server 127.0.0.1:2181</pre></div><br><div><br><br></div><br><div><br><br></div>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/8/26 10:05:51 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38842665)
&lt;/div&gt;
&lt;div&gt;
阅读：1153 评论：0 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38842665#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/21/原-Android学习路线（二十四）ActionBar-Fragment运用最佳实践/" itemprop="url">
                  [原]Android学习路线（二十四）ActionBar Fragment运用最佳实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-08-21T03:03:52+08:00" content="2014-08-21">
              2014-08-21
            </time>
          </span>

          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="font-size:14px">转载请注明出处：<a href="http://blog.csdn.net/sweetvvck/article/details/38645297" target="_blank" rel="external">http://blog.csdn.net/sweetvvck/article/details/38645297</a></span></p>
<p><span style="font-size:14px">通过前面的几篇博客，大家看到了Google是如何解释action bar和fragment以及推荐的用法。俗话说没有demo的博客不是好博客，下面我会介绍一下action bar和fragment在实战中的应用，以及相关demo源码，希望和大家相互交流。</span></p>
<p><span style="font-size:14px">了解过fragment的同学们应该都知道，fragment是android 3.0版本才出现的的，因此如果要在支持android 3.0一下版本的工程中使用fragment的话是需要添加Support Library的。具体如何添加我就不再赘述，可以看我前面的博客</span><span style="font-size:14px"><a href="http://blog.csdn.net/sweetvvck/article/details/38566871" target="_blank" rel="external">Android学习路线（二十一）运用Fragment构建动态UI——创建一个Fragment</a>，下面的项目支持到API<br> Level最低为8，所以项目中也会使用到Support Library。</span></p>
<p><span style="font-size:14px">作为一个有上进心的Android开发者，我们是希望项目的设计符合<strong>Android Design</strong>的。Android Design是Google官方推荐的应用设计原则，<span style="font-size:14px">不了解Android Design的同学可以去了解下，我这里有<a href="http://download.csdn.net/detail/sweetvvck/7835793" target="_blank" rel="external">官方翻译文档</a>。</span></span></p>
<p><span style="font-size:14px">我发现“知乎”的App设计是符合Android Design的，那么我们的项目就来模仿知乎的主界面。首先看下效果图：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140818082016785?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="">&nbsp;<br> &nbsp; &nbsp; &nbsp;<img src="http://img.blog.csdn.net/20140818082105582?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">我们来分析一下这样的界面应该怎么实现，从上图可以看出“知乎”android端使用了action bar和drawerlayout，同时drawer中item切换主界面应该是fragment。</span></p>
<p><span style="font-size:14px">新建一个工程FakeZhihu：</span></p>
<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20140818083926546?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="">&nbsp;&nbsp;<img src="http://img.blog.csdn.net/20140821010348778?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></span></p>
<p></p>
<p><span style="font-size:14px">&nbsp; &nbsp; &nbsp; 从上图可以看到，使用最新的adt插件创建android项目时，如果选择的Minimum Required SDK为8，而Target SDK大于它的话，系统会自动在项目中导入Support v4包；在创建项目向导最后一步可以选择Navigation Type，如果选择了Navigation Drawer，adt工具会在创建项目时自动生成DrawerLayout相关示例代码。但由于DrawerLayout是在高版本的API中出现的，因此adt工具会帮助导入Support<br> v7 appcompat包，这样DrawerLayout就可以兼容到Android2.2了。</span><span style="font-size:14px">没有使用最新版的adt工具也没有关系，我提供的demo里有Support v4包和Support v7包，大家可以直接使用。</span></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px">&nbsp; &nbsp; &nbsp; 下面来看看代码如何实现，android默认的holo主题只提供两种色调，和官方的action bar比较可以看出“知乎”的action bar的颜色以及action bar上action item的颜色以及title的字体大小都是自定义的，那么我们来模仿它自定义一下action bar。</span></p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px">&nbsp; &nbsp; &nbsp; 首先我们打开res目录下的style文件，自定义一个主题和action bar的style，然后在自定义主题中引用自定义的action bar的style：</span></p>
<p><span style="font-size:14px"></span></p>
<pre code_snippet_id="455217" snippet_file_name="blog_20140821_1_8330842" class="html" name="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;!-- the theme applied to the application or activity --&gt;
    &lt;style name=&quot;CustomActionBarTheme&quot;
           parent=&quot;@style/Theme.AppCompat.Light.DarkActionBar&quot;&gt;
        &lt;item name=&quot;android:actionBarStyle&quot;&gt;@style/MyActionBar&lt;/item&gt;

        &lt;!-- Support library compatibility --&gt;
        &lt;item name=&quot;actionBarStyle&quot;&gt;@style/MyActionBar&lt;/item&gt;
    &lt;/style&gt;

    &lt;!-- ActionBar styles --&gt;
    &lt;style name=&quot;MyActionBar&quot;
           parent=&quot;@style/Widget.AppCompat.Light.ActionBar.Solid.Inverse&quot;&gt;
        &lt;item name=&quot;android:background&quot;&gt;@drawable/actionbar_background&lt;/item&gt;
        &lt;item name=&quot;android:titleTextStyle&quot;&gt;@style/MyTitleStyle&lt;/item&gt;

        &lt;!-- Support library compatibility --&gt;
        &lt;item name=&quot;background&quot;&gt;@drawable/actionbar_background&lt;/item&gt;
        &lt;item name=&quot;titleTextStyle&quot;&gt;@style/MyTitleStyle&lt;/item&gt;
    &lt;/style&gt;
    &lt;style name=&quot;MyTitleStyle&quot;
           parent=&quot;@android:style/TextAppearance.Holo.Widget.ActionBar.Title.Inverse&quot;&gt;
        &lt;item name=&quot;android:textSize&quot;&gt;20dp&lt;/item&gt;
    &lt;/style&gt;
&lt;/resources&gt;</pre>这里要注意的是<span style="color:#ff0000">**无论是在自定义主题还是自定义style时，要根据情况加上parent属性，如果没有加上相应的parent属性的话就不能使用父style中没有被覆盖的样式**</span>。具体如何设置action bar的style可以参考[
 Android学习路线（九）为Action Bar添加Style](http://blog.csdn.net/sweetvvck/article/details/38409785)。

<span style="font-size:14px">完成自定义主题和style后要记得在manifest文件中应用：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_2_6630166" class="html" name="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    package=&quot;com.sweetvvck.fakezhihu&quot;
    android:versionCode=&quot;1&quot;
    android:versionName=&quot;1.0&quot; &gt;

    &lt;uses-sdk
        android:minSdkVersion=&quot;8&quot;
        android:targetSdkVersion=&quot;19&quot; /&gt;

    &lt;application
        android:allowBackup=&quot;true&quot;
        android:icon=&quot;@drawable/ic_launcher&quot;
        android:label=&quot;@string/app_name&quot;
        android:theme=&quot;@style/CustomActionBarTheme&quot; &gt;
        &lt;activity
            android:name=&quot;com.sweetvvck.fakezhihu.MainActivity&quot;
            android:label=&quot;@string/app_name&quot; &gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;

                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;

&lt;/manifest&gt;
</pre>这里可以让整个应用都使用自定义的主题，也可以指定单个activity使用，使用android:theme属性来指定。

<span style="font-size:14px">接下来要给app添加DrawerLayout了，修改MainActivity的布局文件，添加一个DrawerLayout，内容非常简单，其中包含一个Drawer和内容布局的Container：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_3_8026388" class="html" name="code">&lt;android.support.v4.widget.DrawerLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:id=&quot;@+id/drawer_layout&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    tools:context=&quot;com.sweetvvck.fakezhihu.MainActivity&quot; &gt;

    &lt;FrameLayout
        android:id=&quot;@+id/container&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot; /&gt;

    &lt;fragment
        android:id=&quot;@+id/navigation_drawer&quot;
        android:name=&quot;com.sweetvvck.fakezhihu.NavigationDrawerFragment&quot;
        android:layout_width=&quot;@dimen/navigation_drawer_width&quot;
        android:layout_height=&quot;match_parent&quot;
        android:layout_gravity=&quot;start&quot; /&gt;

&lt;/android.support.v4.widget.DrawerLayout&gt;
</pre>注意，下面那个fragment就是app的Drawer，**其中的属性android:layout_gravity在这里表示Drawer从哪一侧划出，start代表左侧，end代表右侧；还可以定义两个fragment，然后一个左侧划出一个右侧划出**，DrawerLayout在之后会详细讲解，这里先简单了解如何使用。

<span style="font-size:14px">创建完DrawerLayout布局后，我们来为Drawer定义一个fragment，我们可以看到知乎的Drawer中只是包含了一个ListView。这个ListView的第一项和其它项的布局不一样，我们可以想到用ListView加上headerView来实现，知道这些后，我们来创建一个NavigationDrawerFragment继承自Fragment，这个fragment的布局包含一个ListView：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_4_4754766" class="html" name="code">&lt;ListView xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:background=&quot;#fff&quot;
    android:choiceMode=&quot;singleChoice&quot;
    android:divider=&quot;#c3c3c3&quot;
    android:dividerHeight=&quot;0.5dp&quot;
    tools:context=&quot;com.sweetvvck.fakezhihu.NavigationDrawerFragment&quot; /&gt;
</pre>使用一个ArrayList来存放ListView的数据，定义一个DrawerListItem对象来存放每个Item的title和icon的资源ID：

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_5_8135855" class="html" style="font-size: 14px;" name="code">&lt;string-array name=&quot;item_title&quot;&gt;
    &lt;item&gt;首页&lt;/item&gt;
    &lt;item&gt;发现&lt;/item&gt;
    &lt;item&gt;关注&lt;/item&gt;
    &lt;item&gt;收藏&lt;/item&gt;
    &lt;item&gt;草稿&lt;/item&gt;
    &lt;item&gt;搜索&lt;/item&gt;
    &lt;item&gt;提问&lt;/item&gt;
    &lt;item&gt;设置&lt;/item&gt;
&lt;/string-array&gt;</pre><pre code_snippet_id="455217" snippet_file_name="blog_20140821_6_2879366" class="java" name="code">String[] itemTitle = getResources().getStringArray(R.array.item_title);
int[] itemIconRes = {
  R.drawable.ic_drawer_home,
  R.drawable.ic_drawer_explore,
  R.drawable.ic_drawer_follow,
  R.drawable.ic_drawer_collect,
  R.drawable.ic_drawer_draft,
  R.drawable.ic_drawer_search,
  R.drawable.ic_drawer_question,
  R.drawable.ic_drawer_setting};

for (int i = 0; i &lt; itemTitle.length; i++) {
    DrawerListItem item = new DrawerListItem(getResources().getDrawable(itemIconRes[i]), itemTitle[i]);
    mData.add(item);

}</pre>准备好数据后为该ListView设置Adapter，我们发现这个ListView是Single Choice模式的，并且每个Item被选中后会高亮。那么如何来实现这个功能呢？

<span style="font-size:14px">实现这样的效果有两个步骤：</span>

<span style="font-size:14px">&nbsp; &nbsp; &nbsp; 第一：在ListView中指定android:choiceMode=&quot;singleChoice&quot;；</span>

<span style="font-size:14px">&nbsp; &nbsp; &nbsp; 第二：给ListView的Item的布局设置一个特殊的背景drawable，这个drawable包含当状态为activated时的背景和常态下的背景；同时这个item布局中的图片src和文字颜色也要坐相应的设置；</span>

<span style="font-size:14px">item的背景：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_7_8179283" class="html" name="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:state_activated=&quot;true&quot; android:drawable=&quot;@drawable/activated_background_color&quot; /&gt;
    &lt;item android:drawable=&quot;@android:color/transparent&quot; /&gt;
&lt;/selector&gt;</pre>图片的src，这里以home为例：

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_8_1003966" class="html" name="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:state_activated=&quot;true&quot; android:drawable=&quot;@drawable/ic_drawer_home_pressed&quot; /&gt;
    &lt;item android:drawable=&quot;@drawable/ic_drawer_home_normal&quot; /&gt;
&lt;/selector&gt;</pre>文字的颜色：

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_9_6336903" class="html" name="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;!-- Copyright (C) 2011 Google Inc. All Rights Reserved. --&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:state_enabled=&quot;false&quot;
        android:color=&quot;#ff999999&quot;/&gt;
    &lt;item android:state_activated=&quot;true&quot;
        android:color=&quot;@android:color/white&quot; /&gt;
    &lt;item
        android:color=&quot;#636363&quot; /&gt;
&lt;/selector&gt;
</pre>这样就能实现ListView点击Item高亮的效果了。

<span style="font-size:14px">

</span>

<span style="font-size:14px">考虑到用户在第一次使用app的时候可能不知道有Drawer的存在，我们可以在app第一次被启动时让Drawer处于打开状态，之后再默认隐藏，**这是实际项目中常用的手段**，这里我们用sharedpreference来实现：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_10_764769" class="java" name="code">// 通过这个flag判断用户是否已经知道drawer了，第一次启动应用显示出drawer（抽屉），之后启动应用默认将其</pre><pre code_snippet_id="455217" snippet_file_name="blog_20140821_11_1401" class="java" name="code">SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(getActivity());
mUserLearnedDrawer = sp.getBoolean(PREF_USER_LEARNED_DRAWER, false);</pre>接下来，要实现Drawer的fragment和宿主activity之间的通讯，需要定义一个回调接口，并且在宿主activity中实现：

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_12_2269675" class="java" name="code">/**
* 宿主activity要实现的回调接口</pre><pre code_snippet_id="455217" snippet_file_name="blog_20140821_13_7570375" class="java" name="code">* 用于activity与该fragment之间通讯
*/
public static interface NavigationDrawerCallbacks {
    /**
     * 当drawer中的某个item被选择是调用该方法
    */
    void onNavigationDrawerItemSelected(String title);
}</pre><pre code_snippet_id="455217" snippet_file_name="blog_20140821_14_8203230" class="java" name="code">@Override
public void onNavigationDrawerItemSelected(String title) {
    FragmentManager fragmentManager = getSupportFragmentManager();
    FragmentTransaction ft = fragmentManager.beginTransaction();
    currentFragment = fragmentManager.findFragmentByTag(title);
    if(currentFragment == null) {
        currentFragment = ContentFragment.newInstance(title);
        ft.add(R.id.container, currentFragment, title);
    }
    if(lastFragment != null) {
        ft.hide(lastFragment);
    }
    if(currentFragment.isDetached()){
        ft.attach(currentFragment);
    }
    ft.show(currentFragment);
    lastFragment = currentFragment;
    ft.commit();
    onSectionAttached(title);
}</pre>具体如何来创建一个fragment以及如何实现fragment和activity之间的通讯，可以参考：[Android学习路线（二十一）运用Fragment构建动态UI——创建一个Fragment](http://blog.csdn.net/sweetvvck/article/details/38566871)&nbsp;和&nbsp;[Android学习路线（二十三）运用Fragment构建动态UI——Fragment间通讯](http://blog.csdn.net/sweetvvck/article/details/38569351)&nbsp;；完整的<span style="font-size:14px">NavigationDrawerFragment代码如下：</span>

<span style="font-size:14px"></span>

<pre code_snippet_id="455217" snippet_file_name="blog_20140821_15_7832736" class="java" name="code">package com.sweetvvck.fakezhihu;

import java.util.ArrayList;
import java.util.List;

import android.app.Activity;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.v4.app.ActionBarDrawerToggle;
import android.support.v4.app.Fragment;
import android.support.v4.view.GravityCompat;
import android.support.v4.widget.DrawerLayout;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBarActivity;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ListView;
import android.widget.Toast;

/**
 * 用于管理交互和展示抽屉导航的Fragment。
 * 参考&lt;a href=&quot;https://developer.android.com/design/patterns/navigation-drawer.html#Interaction&quot;&gt;
 * 设计向导&lt;/a&gt; 
 */
public class NavigationDrawerFragment extends Fragment {

    /**
     * 存放选中item的位置
     */
    private static final String STATE_SELECTED_POSITION = &quot;selected_navigation_drawer_position&quot;;

    /**
     * 存放用户是否需要默认开启drawer的key
     */
    private static final String PREF_USER_LEARNED_DRAWER = &quot;navigation_drawer_learned&quot;;

    /**
     * 宿主activity实现的回调接口的引用
     */
    private NavigationDrawerCallbacks mCallbacks;

    /**
     * 将action bar和drawerlayout绑定的组件
     */
    private ActionBarDrawerToggle mDrawerToggle;

    private DrawerLayout mDrawerLayout;
    private ListView mDrawerListView;
    private View mFragmentContainerView;

    private int mCurrentSelectedPosition = 0;
    private boolean mFromSavedInstanceState;
    private boolean mUserLearnedDrawer;
    private List&lt;DrawerListItem&gt; mData = new ArrayList&lt;DrawerListItem&gt;();

    public NavigationDrawerFragment() {
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // 通过这个flag判断用户是否已经知道drawer了，第一次启动应用显示出drawer（抽屉），之后启动应用默认将其隐藏
        SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(getActivity());
        mUserLearnedDrawer = sp.getBoolean(PREF_USER_LEARNED_DRAWER, false);

        if (savedInstanceState != null) {
            mCurrentSelectedPosition = savedInstanceState.getInt(STATE_SELECTED_POSITION);
            mFromSavedInstanceState = true;
        }

    }

    @Override
    public void onActivityCreated (Bundle savedInstanceState) {
        super.onActivityCreated(savedInstanceState);
        // 设置该fragment拥有自己的actionbar action item
        setHasOptionsMenu(true);
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
            Bundle savedInstanceState) {
        mDrawerListView = (ListView) inflater.inflate(R.layout.fragment_navigation_drawer, container, false);
        View headerView = inflater.inflate(R.layout.list_header, null);
        mDrawerListView.addHeaderView(headerView);
        mDrawerListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
                selectItem(position);
            }
        });
        String[] itemTitle = getResources().getStringArray(R.array.item_title);
        int[] itemIconRes = {
            R.drawable.ic_drawer_home,
            R.drawable.ic_drawer_explore,
            R.drawable.ic_drawer_follow,
            R.drawable.ic_drawer_collect,
            R.drawable.ic_drawer_draft,
            R.drawable.ic_drawer_search,
            R.drawable.ic_drawer_question,
            R.drawable.ic_drawer_setting};

        for (int i = 0; i &lt; itemTitle.length; i++) {
            DrawerListItem item = new DrawerListItem(getResources().getDrawable(itemIconRes[i]), itemTitle[i]);
            mData.add(item);

        }
        selectItem(mCurrentSelectedPosition);
        DrawerListAdapter adapter = new DrawerListAdapter(this.getActivity(), mData);
        mDrawerListView.setAdapter(adapter);
        mDrawerListView.setItemChecked(mCurrentSelectedPosition, true);
        return mDrawerListView;
    }

    public boolean isDrawerOpen() {
        return mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(mFragmentContainerView);
    }

    /**
     * 设置导航drawer
     *
     * @param fragmentId   fragmentent的id
     * @param drawerLayout fragment的容器
     */
    public void setUp(int fragmentId, DrawerLayout drawerLayout) {
        mFragmentContainerView = getActivity().findViewById(fragmentId);
        mDrawerLayout = drawerLayout;

        mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);

        ActionBar actionBar = getActionBar();
        actionBar.setDisplayHomeAsUpEnabled(true);
        actionBar.setHomeButtonEnabled(true);
        //隐藏Action bar上的app icon
        actionBar.setDisplayShowHomeEnabled(false);

        mDrawerToggle = new ActionBarDrawerToggle(
                getActivity(),                    /* 宿主 */
                mDrawerLayout,                    /* DrawerLayout 对象 */
                R.drawable.ic_drawer,             /* 替换actionbar上的&#39;Up&#39;图标 */
                R.string.navigation_drawer_open,  
                R.string.navigation_drawer_close
        ) {
            @Override
            public void onDrawerClosed(View drawerView) {
                super.onDrawerClosed(drawerView);
                if (!isAdded()) {
                    return;
                }

                getActivity().supportInvalidateOptionsMenu(); // 调用 onPrepareOptionsMenu()
            }

            @Override
            public void onDrawerOpened(View drawerView) {
                super.onDrawerOpened(drawerView);
                if (!isAdded()) {
                    return;
                }

                if (!mUserLearnedDrawer) {
                    mUserLearnedDrawer = true;
                    SharedPreferences sp = PreferenceManager.getDefaultSharedPreferences(getActivity());
                    sp.edit().putBoolean(PREF_USER_LEARNED_DRAWER, true).commit();
                }

                getActivity().supportInvalidateOptionsMenu(); // 调用 onPrepareOptionsMenu()
            }
        };

        // 如果是第一次进入应用，显示抽屉
        if (!mUserLearnedDrawer &amp;&amp; !mFromSavedInstanceState) {
            mDrawerLayout.openDrawer(mFragmentContainerView);
        }

        mDrawerLayout.post(new Runnable() {
            @Override
            public void run() {
                mDrawerToggle.syncState();
            }
        });

        mDrawerLayout.setDrawerListener(mDrawerToggle);
    }

    private void selectItem(int position) {
        mCurrentSelectedPosition = position;
        if (mDrawerListView != null) {
            mDrawerListView.setItemChecked(position, true);
        }
        if (mDrawerLayout != null) {
            mDrawerLayout.closeDrawer(mFragmentContainerView);
        }
        if (mCallbacks != null) {
            if(mCurrentSelectedPosition == 0) {
                mCallbacks.onNavigationDrawerItemSelected(getString(R.string.app_name));
                return;
            }
            mCallbacks.onNavigationDrawerItemSelected(mData.get(position - 1).getTitle());
        }
    }

    @Override
    public void onAttach(Activity activity) {
        super.onAttach(activity);
        try {
            mCallbacks = (NavigationDrawerCallbacks) activity;
        } catch (ClassCastException e) {
            throw new ClassCastException(&quot;Activity must implement NavigationDrawerCallbacks.&quot;);
        }
    }

    @Override
    public void onDetach() {
        super.onDetach();
        mCallbacks = null;
    }

    @Override
    public void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        outState.putInt(STATE_SELECTED_POSITION, mCurrentSelectedPosition);
    }

    @Override
    public void onConfigurationChanged(Configuration newConfig) {
        super.onConfigurationChanged(newConfig);
        // 当系统配置改变时调用DrawerToggle的改变配置方法（例如横竖屏切换会回调此方法）
        mDrawerToggle.onConfigurationChanged(newConfig);
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        //当抽屉打开时显示应用全局的actionbar设置
        if (mDrawerLayout != null &amp;&amp; isDrawerOpen()) {
            inflater.inflate(R.menu.global, menu);
            showGlobalContextActionBar();
        }
        super.onCreateOptionsMenu(menu, inflater);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        if (mDrawerToggle.onOptionsItemSelected(item)) {
            return true;
        }

        if (item.getItemId() == R.id.action_example) {
            Toast.makeText(getActivity(), &quot;Example action.&quot;, Toast.LENGTH_SHORT).show();
            return true;
        }

        return super.onOptionsItemSelected(item);
    }

    /**
     * 当抽屉打开时显示应用全局的actionbar设置
     */
    private void showGlobalContextActionBar() {
        ActionBar actionBar = getActionBar();
        actionBar.setDisplayShowTitleEnabled(true);
        actionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_STANDARD);
        actionBar.setTitle(R.string.app_name);
    }

    private ActionBar getActionBar() {
        return ((ActionBarActivity) getActivity()).getSupportActionBar();
    }

    /**
     * 宿主activity要实现的回调接口
     * 用于activity与该fragment之间通讯
     */
    public static interface NavigationDrawerCallbacks {
        /**
         * 当drawer中的某个item被选择是调用该方法
         */
        void onNavigationDrawerItemSelected(String title);
    }

}
</pre>

<p><span style="font-size:14px"></span></p>
<p></p>
<p>这样就完成模仿“知乎”主界面的demo的开发啦，来看看效果如何：</p>
<p><span style="font-size:14px"></span></p>
<p></p>
<p><span style="font-size:14px"></span></p>
<div style="text-align:center"><img src="http://img.blog.csdn.net/20140821024716201?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="">&nbsp;&nbsp;<img src="http://img.blog.csdn.net/20140821024753703?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="">&nbsp;&nbsp;<img src="http://img.blog.csdn.net/20140821024813359?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3dlZXR2dmNr/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></div>

<p><span style="font-size:14px">怎么样，很像吧，Drawer是不是简直可以以假乱真了，哈哈。</span></p>
<p><span style="font-size:14px">demo地址：<a href="http://download.csdn.net/detail/sweetvvck/7794083" target="_blank" rel="external">http://download.csdn.net/detail/sweetvvck/7794083</a></span></p>
<p><span style="font-size:14px">其实demo中还有写知识点没有讲到，比如drawer划开时和关闭时action bar上的action item其实是不一样的，这时如何实现的呢？怎么设置action bar不现实logo/icon？选择Drawer中listview的item切换fragment可以每选择一次都replace一次fragment，但是这样每次都得重新创建一个fragment，如果fragment初始化较复杂就更占资源，此时可以配合使用add，hide，show来实现切换同时将以加载过的fragment缓存起来……由于篇幅原因，这些问题都会在之后的博客中详细讲到的~</span></p>
<div style="top:0px">&#65279;&#65279;</div>

<pre><code>&lt;div&gt;
    作者：sweetvvck 发表于2014/8/21 3:03:52 [原文链接](http://blog.csdn.net/sweetvvck/article/details/38645297)
&lt;/div&gt;
&lt;div&gt;
阅读：6955 评论：20 [查看评论](http://blog.csdn.net/sweetvvck/article/details/38645297#comments)
&lt;/div&gt;
</code></pre>
          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/3828494?v=3&s=460"
               alt="Sweetvvck" />
          <p class="site-author-name" itemprop="name">Sweetvvck</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/sweetvvck" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/sweetvvck" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/sweetvvck" target="_blank">
                  
                    <i class="fa fa-globe"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.v2ex.com/member/sweetvvck" target="_blank">
                  
                    <i class="fa fa-globe"></i> V2ex
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sweetvvck</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  

  
  


</body>
</html>
